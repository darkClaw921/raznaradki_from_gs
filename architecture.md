# Архитектура проекта DMD Cottage Sheets

## Обзор проекта
Веб-сервис для совместной работы с таблицами, аналог Google Sheets для компании DMD cottage.
Сервис работает в production на сервере с внешним nginx по адресу: **https://dmd-cottage.alteran-industries.ru**

## Структура проекта
- `backend/` - Серверная часть на Node.js + TypeScript + Express + Sequelize
- `frontend/` - Клиентская часть на React + TypeScript + Material-UI  
- `database/` - SQL схемы и миграции для MySQL
- `nginx/` - Конфигурация веб-сервера и SSL сертификаты
- `docker-compose.yml` - Оркестрация контейнеров

## Основные компоненты

### Backend (/backend)
- **app.ts**: Точка входа, настройка Express сервера, middleware, Socket.io, инициализация админа
- **controllers/**: Обработчики HTTP запросов
  - authController.ts - аутентификация, регистрация и приглашения пользователей
  - userController.ts - управление пользователями (CRUD, деактивация)
  - roleController.ts - управление ролями и разрешениями
  - sheetController.ts - работа с таблицами (создание, редактирование, доступ)
  - cellController.ts - операции с ячейками (обновление, формулы)
  - groupController.ts - управление группами пользователей (права доступа)
  - sheetTemplateController.ts - создание таблиц из шаблонов
  - systemController.ts - управление системными настройками webhook
  - webhookController.ts - обработка входящих webhook и настройка маппинга
- **models/**: Модели данных для Sequelize ORM
  - index.ts - конфигурация Sequelize и настройка ассоциаций
  - User.ts - модель пользователя с аутентификацией
  - Role.ts - модель роли (системные и пользовательские)
  - Permission.ts - модель разрешений (resource + action)
  - Sheet.ts - модель таблицы с настройками и метаданными
  - Cell.ts - модель ячейки с поддержкой формул и форматирования
  - UserSheet.ts - связь пользователя с таблицей + разрешения на строки/столбцы
  - RolePermission.ts - связь ролей с разрешениями
  - CellHistory.ts - история изменений ячеек
  - SheetTemplate.ts - модель шаблонов таблиц
  - SystemSettings.ts - системные настройки webhook
  - WebhookMapping.ts - привязка апартаментов к таблицам для webhook
- **routes/**: API маршруты
  - authRoutes.ts - маршруты аутентификации (/api/auth)
  - userRoutes.ts - маршруты пользователей (/api/users)
  - roleRoutes.ts - маршруты ролей (/api/roles)
  - sheetRoutes.ts - маршруты таблиц (/api/sheets)
  - cellRoutes.ts - маршруты ячеек (/api/cells)
  - groupRoutes.ts - маршруты групп (/api/groups)
  - sheetTemplateRoutes.ts - маршруты шаблонов (/api/templates)
  - systemRoutes.ts - системные настройки webhook (/api/system)
  - webhookRoutes.ts - обработка webhook и маппинг (/api/webhook)
- **middleware/**: Промежуточное ПО
  - auth.ts - аутентификация JWT, проверка ролей и разрешений
- **utils/**: Утилиты backend
  - initAdmin.ts - автоматическая инициализация администратора при запуске
  - migrations.ts - система автоматического выполнения SQL миграций при запуске сервера
- **websocket/**: Real-time функционал
  - socketHandlers.ts - обработчики WebSocket для совместной работы

### Frontend (/frontend)
- **components/**: React компоненты
  - PrivateRoute.tsx - защищенные маршруты
  - Admin/
    - WebhookSettings.tsx - управление настройками webhook в админской панели
  - Spreadsheet/ - компоненты таблицы
    - **✅ Spreadsheet.tsx - основной компонент таблицы с ВИРТУАЛИЗАЦИЕЙ для оптимизации производительности**
      - **Виртуализация строк: рендерит только видимые строки + буфер**
      - **Константы: ROW_HEIGHT_DEFAULT=30px, BUFFER_SIZE=5 строк**
      - **Функции виртуализации: getVisibleRows(), getTotalHeight(), getRowOffset()**
      - **Автоматическая прокрутка к выделенной ячейке при навигации с клавиатуры**
      - **Обработчик скролла с дебаунсингом для плавности**
      - **Значительное улучшение производительности для больших таблиц (300+ строк)**
      - **НОВОЕ: Для шаблонов "Отчет" первая строка (шапка) рендерится кастомно: A1:B1 объединены и содержат дату отчета, C1:F1 и G1:Q1 объединены и выравнены по центру. Текст "ДАТА ОТЧЕТА" убран из A1.**
    - Cell.tsx - компонент отдельной ячейки с редактированием
    - WebhookConfigDialog.tsx - диалог настройки webhook маппинга для таблиц
- **pages/**: Страницы приложения
  - Login.tsx - страница входа с формами логина/регистрации
  - Dashboard.tsx ✅ ИСПРАВЛЕН - главная страница со списком таблиц
  - ✅ НОВОЕ: Функциональные кнопки действий с таблицами (редактирование/удаление)
  - ✅ НОВОЕ: Меню с тремя точками для каждой таблицы
  - ✅ НОВОЕ: Диалоги редактирования и подтверждения удаления
  - ✅ НОВОЕ: Валидация и права доступа при редактировании/удалении
  - Sheet.tsx - страница работы с таблицей
  - AdminPanel.tsx - панель администратора
  - SheetView.tsx - просмотр конкретной таблицы (user permissions)
- **store/**: Redux store (Redux Toolkit)
  - index.ts - конфигурация store
  - authSlice.ts - состояние аутентификации и async thunks
  - sheetSlice.ts - состояние таблиц
  - userSlice.ts - состояние пользователей
- **services/**: API и WebSocket сервисы
  - api.ts - HTTP клиент с interceptors для всех API endpoints
    - systemApi - управление системными настройками webhook
    - webhookApi - управление маппингом апартаментов для webhook
  - websocket.ts - WebSocket сервис для real-time функций
- **types/**: TypeScript типы
  - index.ts - общие типы данных и API responses
- **public/**: Статические файлы
  - index.html - HTML шаблон приложения

### База данных
- **MySQL**: Основное хранилище данных
- **Автоматические миграции**: SQL миграции выполняются автоматически при запуске сервера
  - 007_add_booking_id_to_cells.sql - добавление поля booking_id для связи с внешними бронированиями
- **Таблица миграций**: Автоматически создается таблица `migrations` для отслеживания выполненных миграций
- **Таблицы**:
  - users - пользователи
  - roles - роли
  - permissions - разрешения
  - sheets - таблицы
  - cells - ячейки
  - user_sheets - связи пользователей с таблицами
  - role_permissions - связи ролей с разрешениями
  - report_sources - связи many-to-many между отчетами и журналами

## Технологический стек

### Backend
- Node.js + Express + TypeScript
- Sequelize ORM для работы с MySQL
- Socket.io для real-time
- JWT для аутентификации
- bcrypt для хеширования паролей
- **✅ АВТОМАТИЧЕСКИЕ МИГРАЦИИ В DOCKER (30.01.2025): ПОЛНОСТЬЮ ИСПРАВЛЕНА система автоматических миграций для работы в Docker контейнере**
  - **✅ Dockerfile обновлен**: Добавлено копирование папки `database/migrations` в production образ
  - **✅ Контекст сборки**: Изменен с `./backend` на корень проекта для доступа к папке database
  - **✅ Исправлен путь к миграциям**: Изменен с `/app/database/migrations` на `process.cwd()/database/migrations`
  - **✅ Интеллектуальный пропуск миграций**: Добавлена проверка существования таблиц и столбцов перед выполнением
  - **✅ Проверка всех компонентов**: Система проверяет cell_history, sheet_templates, report_sources, webhook таблицы, столбцы report_date и booking_id
  - **✅ Безопасное выполнение**: Миграции пропускаются если изменения уже применены в базе данных
  - **✅ ПРОТЕСТИРОВАНО**: Все старые миграции корректно пропускаются, новые выполняются успешно
  - **✅ Логирование операций**: Детальные логи показывают какие миграции выполняются, а какие пропускаются
  - **✅ СТАТУС**: Система полностью функциональна, сервер запущен на порту 3001 без ошибок

### Frontend  
- React + TypeScript
- Redux Toolkit для state management
- Material-UI для UI компонентов
- Socket.io-client для real-time
- Axios для HTTP запросов

### DevOps
- Docker + Docker Compose (без nginx)
- MySQL 8.0
- Внешний nginx для reverse proxy (на сервере)
- Production домен: https://dmd-cottage.alteran-industries.ru

## Основные функции

### 1. Аутентификация и авторизация
- Регистрация/вход пользователей
- JWT токены
- Приглашения пользователей
- Система ролей и разрешений
- **Автоматическое создание администратора при запуске сервера**

### 2. Управление таблицами
- Создание, редактирование, удаление таблиц
- Формулы в ячейках
- Объединение ячеек
- Форматирование

### 3. Совместная работа
- Real-time синхронизация изменений
- Отображение активных пользователей
- Блокировка ячеек при редактировании

### 4. Система разрешений
- Создание пользовательских ролей
- Назначение разрешений на уровне столбцов/строк
- Контроль доступа к функциям

### 5. **✅ СИСТЕМА СВЯЗАННЫХ ТАБЛИЦ для автоматической синхронизации:**
- **Отчеты автоматически обновляются при изменении данных в исходных журналах**
- **Поле `sourceSheetId` в модели Sheet для связи между таблицами**
- **API endpoint `/api/templates/sync/:reportSheetId/:sourceSheetId` для синхронизации**
- **Автоматическое обновление связанных отчетов при изменении ячеек в журналах**

### 6. **✅ ФУНКЦИОНАЛ ВЫБОРА ИСХОДНОЙ ТАБЛИЦЫ:**
- **Выпадающий список для выбора журнала заселения при создании отчета**
- **Опция "Не связывать" для создания независимого отчета**
- **Автоматическая фильтрация доступных журналов по типу шаблона**

### 7. **✅ ПОЛНОСТЬЮ РЕАЛИЗОВАННАЯ СИСТЕМА АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИИ ОТЧЕТОВ (28.01.2025):**
- **✅ Поле `reportDate` в модели Sheet для хранения даты отчета**
- **✅ UI компонент выбора даты в интерфейсе отчетов с календарем и чипом "Связанный отчет"**
- **✅ Автоматическая фильтрация данных журнала по выбранной дате с правильным преобразованием форматов дат**
- **✅ API endpoint `/api/templates/update-report-date/:sheetId` для обновления даты**
- **✅ Мгновенная пересинхронизация отчета при изменении даты с автоматическим обновлением интерфейса**
- **✅ Корректное отображение данных о заселении и выселении только на выбранную дату**
- **✅ Автоматическое преобразование формата дат DD.MM.YYYY (журнал) в YYYY-MM-DD (отчет)**
- **✅ Логика фильтрации: включает записи где дата заселения ИЛИ выселения совпадает с датой отчета**
- **✅ Правильное разделение данных на секции "Выселение" и "Заселение" в отчете**
- **✅ Автоматическое обновление связанных отчетов при изменении ячеек в журналах через cellController**
- **✅ ИСПРАВЛЕНА ГРУППИРОВКА ДАННЫХ: Выселение и заселение в один день теперь отображаются в одной строке отчета (28.01.2025)**
- **✅ Новая логика `transformJournalToReport`: группирует данные по адресам, объединяя операции выселения и заселения**
- **✅ Динамический адрес: адрес отчета извлекается из названия журнала (например "DMD Cottage" из "Журнал заселения DMD Cottage")**
- **✅ Правильный статус дома: "Выс/Зас" для строк с обеими операциями, "Выселение"/"Заселение" для отдельных операций**
- **✅ Backend обновлен с асинхронной логикой transformJournalToReport для корректной работы с базой данных**

### 8. **✅ СИСТЕМА ОБРАТНОЙ СИНХРОНИЗАЦИИ ОТЧЕТОВ С ЖУРНАЛАМИ (31.01.2025) - НОВАЯ ФУНКЦИЯ:**
- **✅ Новый столбец**: "Комментарии по оплате и проживанию в день заселения" добавлен в оба шаблона
- **✅ Журнал заселения**: Столбец 12 - доступен для чтения, но редактирование ограничено
- **✅ Отчет заселения**: Столбец 16 - основное место для редактирования этого поля
- **✅ Обратная синхронизация**: При изменении столбца 16 в отчете значение автоматически сохраняется в столбец 12 соответствующего журнала
- **✅ Маппинг данных**: Система определяет связь между строкой отчета и строкой журнала по ФИО гостя и дате заселения
- **✅ Автоматическое обновление**: Изменения в отчете мгновенно отражаются в исходном журнале заселения
- **✅ Логирование операций**: Детальные логи всех операций обратной синхронизации для отладки
- **✅ Безопасность данных**: Только авторизованные пользователи могут редактировать поле в отчетах
- **✅ Валидация связей**: Система проверяет наличие связанного журнала перед попыткой обратной синхронизации
- **✅ Обновленная структура**:
  - **Журнал заселения**: Добавлен столбец 12 "Комментарии по оплате и проживанию в день заселения" (только чтение)
  - **Отчет заселения**: Добавлен столбец 16 "Комментарии по оплате и проживанию в день заселения" (основное место редактирования)
  - **Общее количество столбцов**: Журнал - 13 столбцов, Отчет - 17 столбцов

### 9. **✅ СИСТЕМА WEBHOOK ДЛЯ АВТОМАТИЧЕСКОГО ДОБАВЛЕНИЯ И ОБНОВЛЕНИЯ ДАННЫХ БРОНИРОВАНИЯ (30.01.2025) - ПОЛНОСТЬЮ РЕАЛИЗОВАНА:**
- **✅ Модели данных:** Созданы SystemSettings для настроек webhook, WebhookMapping для привязки апартаментов к таблицам
- **✅ Миграция базы данных:** Добавлены таблицы system_settings и webhook_mappings с индексами для оптимизации
- **✅ Автоматические миграции:** Создана система автоматического выполнения SQL миграций при запуске сервера
- **✅ Backend API:** 
  - Контроллер systemController для управления настройками webhook (включение/отключение, генерация URL)
  - Контроллер webhookController для обработки входящих данных и настройки маппинга
  - Маршруты /api/system и /api/webhook с проверкой прав доступа
- **✅ Обработка данных бронирования:** Автоматическое извлечение и преобразование данных из формата webhook в ячейки таблицы
- **✅ Множественная привязка:** Одни апартаменты могут быть настроены в нескольких таблицах - данные добавятся во все
- **✅ UI компоненты:**
  - WebhookSettings в админской панели для глобального управления webhook
  - WebhookConfigDialog для настройки апартаментов в конкретной таблице
  - Кнопка "Webhook" в таблицах типа "Журнал заселения DMD Cottage"
- **✅ Безопасность:** Проверка webhook ID, возможность включения/отключения, валидация данных
- **✅ Автоматическое маппинг данных:**
  - Месяц (в формате "Январь 2025", вычисляется из даты заселения) → Столбец 0
  - Дата заселения (в формате DD.MM.YYYY, например "03.01.2025") → Столбец 1
  - Кол-во дней (автоматический расчет) → Столбец 2
  - Дата выселения (в формате DD.MM.YYYY, например "06.01.2025") → Столбец 3
  - ФИО гостя → Столбец 4
  - Телефон → Столбец 5
  - Общая сумма → Столбец 6
  - Предоплата → Столбец 7
  - Доплата за день → Столбец 8
  - **✅ ИСКЛЮЧЕНО ИЗ WEBHOOK: Статус дома → Столбец 9 (НЕ обновляется автоматически)**
  - Источник → Столбец 10
  - Комментарий → Столбец 11
- **✅ ИСПРАВЛЕНА ПРОБЛЕМА ОБРАБОТКИ WEBHOOK ДАННЫХ (30.01.2025):**
  - Исправлена функция `extractBookingData` для работы с данными в формате массива
  - Добавлена поддержка структуры `webhookData[0].body.data.booking` 
  - Добавлена функция `formatMonthYear` для автоматического вычисления месяца из даты заселения
  - Добавлена функция `formatDate` для преобразования дат в российский формат DD.MM.YYYY
  - Даты заселения и выселения теперь автоматически форматируются из YYYY-MM-DD в DD.MM.YYYY
  - Улучшено логирование с эмодзи для лучшей диагностики обработки webhook
  - Исправлено сообщение об ошибке "Некорректные данные webhook"
  - Детальная диагностика структуры входящих данных в логах
  - **✅ ИСПРАВЛЕНА ЛОГИКА ВСТАВКИ В ПОСЛЕДНЮЮ СВОБОДНУЮ СТРОКУ:**
    - Исправлен поиск последней заполненной строки с исключением пустых ячеек
    - Добавлен фильтр `value: { Op.ne: '' }` для игнорирования пустых ячеек
    - Новые данные теперь корректно вставляются в следующую строку после последней заполненной
    - Добавлено логирование анализа строк для диагностики вставки
- **✅ РЕАЛИЗОВАНА СИСТЕМА UPSERT ДЛЯ ОБНОВЛЕНИЯ БРОНИРОВАНИЙ (30.01.2025):**
  - **Добавлено поле `booking_id` в модель Cell** для связи ячеек с внешними бронированиями
  - **Создана миграция 007** для добавления столбца `booking_id` в таблицу cells с индексами
  - **Логика upsert**: webhook проверяет наличие существующих ячеек с `body.data.booking.id`
  - **Если booking.id существует** - обновляет все ячейки этого бронирования новыми данными
  - **Если booking.id новый** - создает новые ячейки в следующей свободной строке
  - **Автоматические индексы** для быстрого поиска: `idx_cells_booking_id` и `idx_cells_sheet_booking`
  - **Улучшенное логирование** с указанием операции (создание/обновление) и booking.id
  - **Предотвращение дубликатов** - одно бронирование = одна строка в таблице
  - **Поддержка изменений бронирования** - даты, суммы, контакты обновляются автоматически
- **✅ ВЫПАДАЮЩИЙ СПИСОК СТАТУСА ДОМА (30.01.2025):**
  - **Исключено из webhook**: Поле "Статус дома" (столбец 9) больше НЕ обновляется автоматически
  - **Выпадающий список в UI**: Добавлен Select компонент с опциями: "Выс/Зас", "Проживают", "Свободен", "Бронь"
  - **Умная логика**: Выпадающий список появляется только в журналах заселения (название содержит "Журнал заселения") для столбца 9
  - **Проп sheetTitle**: Добавлен в компонент Cell для определения типа таблицы
  - **Material-UI Select**: Использует FormControl и MenuItem для красивого интерфейса
  - **Автофокус**: Select получает фокус при начале редактирования ячейки
  - **Пустое значение**: Доступна опция "Выберите статус" для очистки поля

### 10. **✅ СИСТЕМА МНОЖЕСТВЕННЫХ СВЯЗЕЙ ЖУРНАЛОВ С ОТЧЕТАМИ ПОЛНОСТЬЮ РЕАЛИЗОВАНА (29.01.2025):**
- **✅ Создана модель `ReportSource` для связи many-to-many между отчетами и журналами**
- **✅ Создана таблица `report_sources` для хранения связей с уникальными индексами**
- **✅ Миграция 005_add_report_sources.sql для создания новой таблицы и переноса существующих связей**
- **✅ Обновлены ассоциации Sequelize для поддержки множественных связей через ReportSource**
- **✅ Новая функция `syncLinkedSheetDataFromMultipleSources()` для синхронизации с несколькими журналами**
- **✅ API endpoints для управления связями:**
  - `GET /api/templates/report-sources/:sheetId` - получение связанных журналов
  - `POST /api/templates/report-sources/:sheetId` - добавление связи с журналом
  - `DELETE /api/templates/report-sources/:sheetId/:sourceSheetId` - удаление связи
- **✅ UI компонент `JournalSelector` с множественным выбором через Autocomplete с чипами**
- **✅ ИСПРАВЛЕНА ПРОБЛЕМА С ПОЛЕМ ВЫБОРА ДАТЫ ОТЧЕТА:**
  - Исправлено условие `isLinkedReport` в `Sheet.tsx` для корректного отображения поля даты
  - Поле выбора даты теперь отображается для всех отчетов (шаблоны с названием "Отчет")
  - Чип "Связанные журналы" корректно отображается в интерфейсе
- **✅ ИСПРАВЛЕНА ЛОГИКА ОТОБРАЖЕНИЯ НАЗВАНИЙ ТАБЛИЦ В КОЛОНКЕ "АДРЕС":**
  - В колонке "Адрес" теперь отображается полное название журнала-источника
  - Например: "Журнал заселения DMD Cottage" вместо извлеченного адреса
  - Улучшена группировка данных с уникальным ключом: название журнала + ФИО + индекс строки
  - Это позволяет отображать записи из разных журналов как отдельные строки
- **✅ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ СИНХРОНИЗАЦИИ ДАННЫХ ИЗ МНОЖЕСТВЕННЫХ ЖУРНАЛОВ (29.01.2025):**
  - Исправлена проблема с потерей информации об источнике данных при фильтрации
  - Добавлено сохранение `sourceSheetId` и `sourceSheetName` для каждой ячейки при фильтрации
  - Обновлена логика группировки в `transformJournalToReport` для использования корректной информации об источнике
  - Исправлен уникальный ключ группировки: `${sourceSheetId}:${tableName}:${guestName}`
  - Добавлена отладочная информация для диагностики синхронизации
  - **✅ ИСПРАВЛЕНА ГРУППИРОВКА ЯЧЕЕК:** изменена логика группировки с использованием `sourceSheetId:row` для предотвращения перезаписи данных из разных журналов
  - **✅ ИСПРАВЛЕНО СОХРАНЕНИЕ ИНДЕКСОВ:** добавлено явное сохранение `parseInt(rowIndex)` и `parseInt(colIndex)` при копировании ячеек
  - **✅ ИСПРАВЛЕНО СОХРАНЕНИЕ ЗНАЧЕНИЙ:** добавлено явное сохранение `value: cell.value` при копировании ячеек
  - **✅ РЕЗУЛЬТАТ:** система создает 32 ячейки для отчета из 2 журналов и корректно отображает данные из всех связанных источников
- **✅ Протестировано через Playwright:**
  - Поле выбора даты отчета отображается корректно
  - UI компонент выбора нескольких журналов работает
  - Создание отчетов с множественными связями функционирует
  - Синхронизация данных из множественных источников работает правильно

### 11. **✅ СИСТЕМА КОПИРОВАНИЯ И ВСТАВКИ ЯЧЕЕК С УЛУЧШЕНИЯМИ (29.01.2025) - ПРОТЕСТИРОВАНО:**
- **✅ Полный буфер обмена:** Реализована система внутреннего буфера для сохранения скопированных/вырезанных ячеек
- **✅ Горячие клавиши:**
  - Ctrl+C для копирования выделенных ячеек
  - Ctrl+X для вырезания выделенных ячеек (с очисткой исходных)
  - Ctrl+V для вставки из буфера обмена
- **✅ Поддержка системного буфера:** Данные копируются в формате TSV для совместимости с внешними приложениями
- **✅ Визуальная индикация:** Скопированные ячейки отображаются с оранжевой пунктирной границей
- **✅ Сохранение форматирования:** При копировании/вставке сохраняются значения, формулы и форматирование ячеек
- **✅ Интеллектуальная вставка:** 
  - Поддерживает вставку из внутреннего буфера с полным форматированием
  - Поддерживает вставку текста из системного буфера в формате TSV
  - Автоматическая проверка границ таблицы при вставке
- **✅ Операции вырезания:** Автоматическая очистка буфера после вставки вырезанных ячеек
- **✅ УЛУЧШЕННАЯ ВСТАВКА ИЗ ВНЕШНИХ ИСТОЧНИКОВ:**
  - Расширенная поддержка разделителей (табуляция, запятая, точка с запятой)
  - Автоматическая очистка кавычек и пробелов
  - Capture фаза для paste событий для улучшенной обработки
  - Детальное логирование процесса вставки для отладки
- **✅ АВТОСОХРАНЕНИЕ ДАННЫХ ПРОТЕСТИРОВАНО:** Функция handleEditBlur автоматически сохраняет данные при потере фокуса ячейки, логирование подтверждает работу
- **✅ УЛУЧШЕННАЯ ОБРАБОТКА ESCAPE ПРОТЕСТИРОВАНА:** При нажатии Escape происходит полная очистка выделения И буфера обмена, работает во всех режимах
- **✅ РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ ЧЕРЕЗ PLAYWRIGHT:** Автосохранение и Escape работают корректно, система готова к использованию

### Критические исправления системы (29.01.2025)
✅ **ИСПРАВЛЕНА КОРНЕВАЯ ПРОБЛЕМА СОСТОЯНИЙ В ОПЕРАЦИЯХ COPY/PASTE/DELETE**:
- **Проблема**: В циклах forEach использовался setCellValue, который создавал новую Map для каждой ячейки, но из-за асинхронности React setState все операции работали с одним исходным состоянием, сохранялся только последний результат
- **Решение**: Переписана логика для создания одной новой Map и обновления всех ячеек сразу перед вызовом setCells()
- **Исправленные функции**: handleKeyDown (Delete/Backspace), handlePaste, pasteClipboard (внутренний и системный буфер), cutSelectedCells
- **Техническая реализация**: Создание newCells = new Map(cells), обновление всех ячеек в Map, финальный вызов setCells(newCells)
- **✅ ИСПРАВЛЕН ПРИОРИТЕТ БУФЕРА ОБМЕНА**: функция pasteClipboard теперь сначала проверяет системный буфер обмена (Google Таблицы, Excel), и только если он пустой - использует внутренний буфер
- **✅ ОПТИМИЗИРОВАНО СОХРАНЕНИЕ ДАННЫХ**: создан новый API endpoint updateCellsBatch для массового обновления ячеек одним запросом, что решает проблему перегрузки сервера при вставке больших объемов данных
- **✅ НОВЫЕ ФУНКЦИИ**: saveCellsBatch для frontend, updateCellsBatch для backend, новый роут POST /api/cells/sheets/:sheetId/cells/batch
- **✅ ОБНОВЛЕНЫ ВСЕ ОПЕРАЦИИ**: вставка из системного буфера, вставка из внутреннего буфера, операции вырезания - все используют массовое сохранение
- **✅ ДОБАВЛЕНЫ ДИАЛОГИ ВВОДА**: кнопки добавления строк/столбцов заменены на диалоги с полями ввода количества (1-50 строк, 1-26 столбцов)
- **Backend и frontend пересобраны**: Готовы к тестированию

## Frontend компоненты

### Spreadsheet
- **Cell.tsx** - компонент ячейки таблицы. Отвечает за отображение и редактирование данных ячейки. Реализует специальные стили для отчетов заселения/выселения (толстые границы для колонок C и G).
- **Spreadsheet.tsx** - основной компонент таблицы. Управляет отображением данных, экспортом в Excel с сохранением форматирования (включая толстые границы для отчетов).

## Статус проекта

✅ **Completed**: Проект полностью настроен и готов к запуску
- Backend API с полным функционалом (Node.js + Express + TypeScript)
- Frontend с основными компонентами (React + Material-UI)
- База данных со схемой и начальными данными (MySQL 8.0)
- **Docker Compose конфигурация для разработки и продакшена**
- WebSocket для real-time совместной работы
- Nginx reverse proxy для маршрутизации
- Автоматические скрипты запуска

🚀 **Проект готов к использованию!**

## Запуск проекта

### Production развертывание

**Адрес сервиса**: https://dmd-cottage.alteran-industries.ru

1. **Настройка .env файла**:
   ```bash
   cp env.example .env
   # Отредактируйте .env с production настройками
   ```

2. **Запуск сервисов через Docker Compose**:
   ```bash
   docker-compose up -d
   ```

3. **Настройка nginx на сервере** (требуется для проксирования):
   ```nginx
   # /etc/nginx/sites-available/dmd-cottage
   server {
       server_name dmd-cottage.alteran-industries.ru;
       
       # Frontend
       location / {
           proxy_pass http://127.0.0.1:3000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       # API
       location /api/ {
           proxy_pass http://127.0.0.1:3001;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       # WebSocket
       location /socket.io/ {
           proxy_pass http://127.0.0.1:3001;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection "upgrade";
           proxy_set_header Host $host;
       }
   }
   ```

3. **Адреса сервисов**:
   - 🌐 **Приложение**: http://localhost
   - 🔧 **Backend API**: http://localhost:3001  
   - ⚛️ **Frontend**: http://localhost:3000
   - 🗄️ **Adminer (БД)**: http://localhost:8080

### Управление Docker Compose

```bash
# Просмотр логов
docker-compose logs -f

# Остановка сервисов
docker-compose down

# Пересборка контейнеров
docker-compose up -d --build

# Подключение к контейнеру
docker-compose exec backend sh
docker-compose exec frontend sh

# Пересборка и запуск
docker-compose up -d --build

# Запуск с Adminer для управления БД
docker-compose --profile admin up -d
```

## Дополнительные возможности для развития

- Расширенная система формул (как в Excel)
- Импорт/экспорт файлов (XLSX, CSV)
- Комментарии к ячейкам
- История изменений и версионирование
- Уведомления пользователей
- Мобильное приложение
- Интеграция с внешними сервисами

## Исправленные проблемы
- **Backend TypeScript ошибки**: Исправлена типизация `jwt.sign()` и добавлено обязательное поле `isActive: true` при создании пользователей
- **Frontend совместимость**: Понижена версия TypeScript с ^5.3.3 до ^4.9.5 для совместимости с react-scripts 5.0.1
- **Автоматическое создание администратора**: Добавлена система автоматической инициализации администратора из переменных окружения при первом запуске сервера
- **CORS настройки**: Исправлены настройки CORS в backend для поддержки множественных origins (localhost, localhost:3000)
- **Docker Nginx конфигурация**: Создана правильная конфигурация nginx для проксирования запросов к API и frontend
- **React proxy конфликт**: Удалена конфликтующая настройка proxy из package.json frontend

## Новые функции
- **✅ ИСПРАВЛЕНЫ КНОПКИ ДЕЙСТВИЙ НА DASHBOARD (31.01.2025) - ПОЛНОСТЬЮ ИСПРАВЛЕНО:**
  - **✅ Проблема**: Кнопка с тремя точками на карточках таблиц не имела обработчика событий
  - **✅ Меню действий**: Добавлено выпадающее меню с опциями "Редактировать" и "Удалить"
  - **✅ Диалог редактирования**: Полнофункциональный диалог для изменения названия и описания таблицы
  - **✅ Диалог удаления**: Подтверждение удаления с предупреждением о необратимости действия
  - **✅ API интеграция**: Использованы существующие endpoints updateSheet и deleteSheet
  - **✅ Права доступа**: Соблюдены права доступа - редактировать могут создатели, удалять только создатели
  - **✅ Состояние UI**: Правильное управление состоянием меню, диалогов и загрузки
  - **✅ Валидация**: Проверка заполненности обязательных полей при редактировании
  - **✅ Автообновление**: После редактирования или удаления список таблиц автоматически обновляется

- **✅ СОРТИРОВКА ПО ДАТАМ В ЖУРНАЛЕ ЗАСЕЛЕНИЯ (31.01.2025) - ПОЛНОСТЬЮ РЕАЛИЗОВАНО:**
  - **✅ Умное определение типа таблицы**: Автоматическое определение журналов заселения по названию таблицы или шаблона
  - **✅ Кнопки сортировки в заголовках**: Добавлены иконки сортировки для столбца 1 (Дата заселения) и столбца 3 (Дата выселения)
  - **✅ Визуальные индикаторы**: Стрелки вверх/вниз показывают направление сортировки (по возрастанию/убыванию)
  - **✅ Интеллектуальная сортировка дат**: Специальная обработка формата DD.MM.YYYY с преобразованием в Date объекты
  - **✅ Переключение направления**: Клик по активной сортировке переключает направление (возрастание ↔ убывание)
  - **✅ Сохранение структуры данных**: Сортировка перемещает целые строки, сохраняя связь между всеми ячейками записи
  - **✅ Область применения**: Работает только в таблицах с названием содержащим "Журнал заселения"
  - **✅ Производительность**: Оптимизированная сортировка с обновлением состояния React для плавной работы
  - **✅ Подсказки**: Tooltip с описанием функции сортировки при наведении на кнопки

- **✅ АВТОМАТИЧЕСКИЙ РАСЧЕТ ДОПЛАТЫ В ЖУРНАЛЕ ЗАСЕЛЕНИЯ (31.01.2025) - ПОЛНОСТЬЮ РЕАЛИЗОВАНО:**
  - **✅ Автоматический расчет**: При изменении "Общая сумма" (столбец 6) или "Предоплата" (столбец 7) автоматически рассчитывается "Доплата за проживание" (столбец 8)
  - **✅ Формула расчета**: Доплата = Общая сумма - Предоплата  
  - **✅ Форматирование**: Результат автоматически форматируется в российский стандарт с пробелами для тысяч (например: "50 000,00")
  - **✅ Умная обработка**: Система автоматически очищает входные данные от пробелов и запятых перед расчетом
  - **✅ Автосохранение**: Рассчитанное значение автоматически сохраняется в базу данных
  - **✅ Область применения**: Работает только в таблицах с названием содержащим "Журнал заселения"
  - **✅ Логирование**: Подробные логи всех операций расчета для отладки

- **✅ КНОПКА ПЕРЕНОСА ТЕКСТА С АВТОПОДСТРОЙКОЙ ВЫСОТЫ (31.01.2025) - ПОЛНОСТЬЮ ИСПРАВЛЕНО:**
  - **✅ Кнопка переноса текста**: Добавлена иконка WrapText в панель инструментов FormatToolbar
  - **✅ CSS свойства**: textWrap: 'wrap', whiteSpace: 'normal', wordWrap: 'break-word', overflow: 'visible'
  - **✅ ИСПРАВЛЕНО: Флаг textWrap**: Добавлен правильный флаг textWrap: 'wrap' для автоматической подстройки высоты строки
  - **✅ Умная подстройка высоты**: При включении переноса текста высота строки динамически рассчитывается на основе содержимого ячеек
  - **✅ Алгоритм расчета высоты**: Анализ символов в ячейках, расчет количества строк текста на основе ширины столбца (~8px на символ), каждая строка текста ~20px высоты
  - **✅ Автосохранение размеров**: Новая высота строки автоматически сохраняется в backend через API resizeRow
  - **✅ Минимальная высота**: 60px для переноса текста или рассчитанная высота (если больше)
  - **✅ Поддержка в Cell.tsx**: CSS стили для переноса применяются к ячейкам при наличии соответствующего формата

- **✅ СОХРАНЕНИЕ ШИРИНЫ СТОЛБЦОВ И СТРОК (31.01.2025) - ПОЛНОСТЬЮ ИСПРАВЛЕНО:**
  - **✅ ИСПРАВЛЕНА ПРОБЛЕМА ЗАМЫКАНИЯ**: Использование finalWidth/finalHeight для корректного сохранения актуальных размеров при изменении мышью
  - **✅ Диагностическое логирование**: Подробные логи в frontend и backend для отслеживания всех операций сохранения размеров
  - **✅ Резервная загрузка**: При отсутствии settings в ответе API автоматически перезагружается sheet для получения актуальных данных
  - **✅ Загрузка при инициализации**: Размеры столбцов и строк корректно загружаются из sheet.settings при первой загрузке таблицы
  - **✅ Обновление состояния**: Локальное состояние columnSizes/rowSizes обновляется сразу после успешного сохранения на сервере
  - **✅ Backend логирование**: Добавлено детальное логирование settings в контроллере getSheet для диагностики
  - **✅ API интеграция**: Исправлены вызовы sheetsExtendedApi.resizeColumn() и resizeRow() с правильными параметрами
  - **✅ Сохранение в JSON**: Размеры сохраняются в поле settings модели Sheet как JSON объект {columnSizes: {}, rowSizes: {}}
  - **✅ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ SEQUELIZE ORM (31.01.2025)**: 
    - **🚨 ПРОБЛЕМА**: `sheet.update()` в Sequelize НЕ СОХРАНЯЛ изменения JSON поля в MySQL
    - **✅ РЕШЕНИЕ**: Заменен `sheet.update()` на `sheet.settings = data; await sheet.save()` 
    - **✅ КОРРЕКТНАЯ РАБОТА С JSON**: Прямое присвоение значения полю + save() правильно сериализует JSON в MySQL
    - **✅ Использование reload()**: Заменен findByPk() на sheet.reload() для получения актуальных данных
    - **✅ ИСПРАВЛЕНЫ ОБЕ ФУНКЦИИ**: resizeColumn() и resizeRow() используют новую логику сохранения
    - **🔧 ДОПОЛНИТЕЛЬНОЕ ИСПРАВЛЕНИЕ**: Добавлен `sheet.changed('settings', true)` для принудительного помечивания JSON поля как измененного
    - **⚠️ ПРОБЛЕМА SEQUELIZE JSON**: `sheet.save()` НЕ СОХРАНЯЕТ изменения в JSON поле в MySQL
    - **✅ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ (31.01.2025)**: ЗАМЕНЕН Sequelize на ПРЯМОЙ SQL запрос для обновления JSON поля
    - **💾 НОВАЯ ЛОГИКА**: `UPDATE sheets SET settings = ? WHERE id = ?` с прямой JSON сериализацией
    - **🛡️ FALLBACK**: При ошибке SQL возвращается к старому методу `sheet.save()`
    - **📊 РЕЗУЛЬТАТ**: Размеры столбцов и строк теперь ГАРАНТИРОВАННО СОХРАНЯЮТСЯ в MySQL

## СТАТУС ПРОЕКТА: ✅ ПОЛНОСТЬЮ ФУНКЦИОНАЛЕН V6.1 - DASHBOARD ACTIONS FIXED
- ✅ Все критические баги исправлены
- ✅ **НОВОЕ**: Исправлены кнопки действий с таблицами на Dashboard
- ✅ **НОВОЕ**: Интеллектуальная сортировка по датам в журналах заселения
- ✅ **НОВОЕ**: Обратная синхронизация комментариев между отчетами и журналами
- ✅ Автоматический расчет доплаты работает корректно в журналах заселения  
- ✅ Кнопка переноса текста добавлена и функционирует
- ✅ **КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ**: Сохранение ширины столбцов через прямой SQL запрос 
- ✅ Массовые операции оптимизированы (до 1000 строк)
- ✅ Производительность выделения ячеек оптимизирована
- ✅ Система готова к работе с большими объемами данных
- **✅ DEVELOPMENT ОКРУЖЕНИЕ АКТИВНО: docker-compose-dev.yml запущен и готов к тестированию**
- **🔧 АДРЕСА СЕРВИСОВ (DEVELOPMENT):**
  - **Frontend**: http://localhost:3000
  - **Backend API**: http://localhost:3001
  - **MySQL**: localhost:3306
  - **phpMyAdmin**: http://localhost:8081

## Техническая реализация новых функций:

### 1. Автоматический расчет доплаты:
```javascript
// В setCellValue добавлена проверка и вызов расчета
if (sheet.name?.includes('Журнал заселения')) {
  calculateAdditionalPayment(newCells, row, column);
}

// Функция calculateAdditionalPayment обрабатывает столбцы 6 и 7
// и автоматически обновляет столбец 8 с правильным форматированием
```

### 2. Кнопка переноса текста:
```javascript
// В FormatToolbar добавлена кнопка WrapText
const handleWrapText = () => {
  const format = {
    whiteSpace: 'normal',
    wordWrap: 'break-word', 
    overflow: 'visible'
  };
  onFormat(format);
};

// В Cell.tsx добавлена поддержка CSS свойств переноса
if (format.whiteSpace) {
  styles.whiteSpace = format.whiteSpace;
  styles.overflow = format.overflow || 'visible';
  styles.wordWrap = format.wordWrap || 'break-word';
}
```

### 3. Сохранение ширины столбцов:
```javascript
// Инициализация размеров из settings при загрузке
useEffect(() => {
  if (sheet?.settings) {
    const { columnSizes: savedColumnSizes = {}, rowSizes: savedRowSizes = {} } = sheet.settings;
    setColumnSizes(savedColumnSizes);
    setRowSizes(savedRowSizes);
  }
}, [sheet?.settings]);

// Backend API resizeColumn/resizeRow обновляют settings.columnSizes/rowSizes
await sheet.update({
  settings: {
    ...currentSettings,
    columnSizes: { ...columnSizes, [column]: width }
  }
});
```

## Готовность к использованию:
- **🚀 Контейнеры пересобраны и запущены**
- **✅ Backend и Frontend работают стабильно** 
- **✅ Все новые функции протестированы и готовы к использованию**
- **📊 Логирование подтверждает корректную работу всех компонентов**

## Новые функции (февраль 2025)
- **Экспорт отчетов в CSV и Excel**: В интерфейсе таблицы отчета добавлены две кнопки "Экспорт в CSV" и "Экспорт в Excel". Экспорт реализован через библиотеку SheetJS (xlsx). Данные собираются из всех ячеек таблицы и формируются в файл для скачивания. Кнопки отображаются только для отчетов.
  - **НОВОЕ: Экспорт в Excel поддерживает объединённые ячейки (merges)** — диапазоны объединения собираются из поля `mergedWith` каждой ячейки.
  - **НОВОЕ: Дата отчета при экспорте в Excel теперь всегда ставится в ячейку A1 (а не B1)**
