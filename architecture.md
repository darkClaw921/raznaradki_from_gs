# Архитектура DMD Cottage Sheets

## Обзор проекта
Веб-сервис для совместной работы с таблицами, аналог Google Sheets для компании DMD cottage.

## Структура проекта

```
raznaradki_from_gs/
├── backend/                    # Backend API на Node.js + Express
│   ├── src/
│   │   ├── controllers/        # Контроллеры API
│   │   │   └── sheetTemplateController.ts  # Контроллер шаблонов таблиц [НОВОЕ]
│   │   ├── models/            # Модели базы данных (Sequelize)
│   │   │   └── SheetTemplate.ts  # Модель шаблонов таблиц [НОВОЕ]
│   │   ├── routes/            # Маршруты API
│   │   │   └── sheetTemplateRoutes.ts  # Маршруты для шаблонов [НОВОЕ]
│   │   ├── middleware/        # Middleware для аутентификации и авторизации
│   │   ├── services/          # Бизнес-логика
│   │   ├── utils/             # Утилиты и хелперы
│   │   │   └── initAdmin.ts  # Автоматическая инициализация администратора
│   │   ├── websocket/         # WebSocket для real-time
│   │   └── app.ts            # Основной файл приложения (обновлен с поддержкой шаблонов)
│   ├── package.json
│   ├── tsconfig.json
│   └── Dockerfile
├── frontend/                   # Frontend на React + TypeScript
│   ├── src/
│   │   ├── components/        # React компоненты
│   │   ├── pages/            # Страницы приложения
│   │   │   └── Dashboard.tsx  # Обновлен с поддержкой шаблонов [РАСШИРЕНО]
│   │   ├── hooks/            # Custom hooks
│   │   ├── services/         # API сервисы
│   │   │   └── api.ts        # Добавлены методы templatesApi [РАСШИРЕНО]
│   │   ├── store/            # State management (Redux Toolkit)
│   │   ├── types/            # TypeScript типы
│   │   │   └── index.ts      # Добавлены типы SheetTemplate [РАСШИРЕНО]
│   │   └── utils/            # Утилиты
│   ├── package.json
│   ├── tsconfig.json
│   └── Dockerfile
├── database/                   # Скрипты и схемы БД
│   ├── migrations/           # Миграции базы данных
│   │   └── 003_add_sheet_templates.sql  # Миграция для шаблонов [НОВОЕ]
│   ├── seeds/               # Начальные данные
│   └── schema.sql           # Схема базы данных
├── docker-compose.yml         # Конфигурация Docker Compose
├── .env.example              # Пример переменных окружения
└── README.md                 # Документация проекта

## Основные компоненты

### Backend (/backend)
- **app.ts**: Точка входа, настройка Express сервера, middleware, Socket.io, инициализация админа
- **controllers/**: Обработчики HTTP запросов
  - authController.ts - аутентификация, регистрация и приглашения пользователей
  - userController.ts - управление пользователями (CRUD, деактивация, создание, массовые операции)
  - roleController.ts - управление ролями и разрешениями
  - groupController.ts - управление группами пользователей
  - sheetController.ts - работа с таблицами (создание, редактирование, доступ, детальные права, добавление строк/столбцов, изменение размеров, управление участниками)
  - cellController.ts - операции с ячейками (обновление, формулы, форматирование, история изменений)
  - **sheetTemplateController.ts** - **работа с шаблонами таблиц (получение списка, создание таблиц из шаблонов)** [НОВОЕ]
- **models/**: Модели данных для Sequelize ORM
  - index.ts - конфигурация Sequelize и настройка ассоциаций
  - User.ts - модель пользователя с аутентификацией
  - Role.ts - модель роли (системные и пользовательские)
  - Permission.ts - модель разрешений (resource + action)
  - Sheet.ts - модель таблицы с настройками и метаданными (включая размеры столбцов и строк, **templateId** для связи с шаблоном)
  - Cell.ts - модель ячейки с поддержкой формул и расширенного форматирования
  - CellHistory.ts - модель истории изменений ячеек
  - UserSheet.ts - связь пользователя с таблицей + разрешения на строки/столбцы
  - RolePermission.ts - связь ролей с разрешениями
  - **SheetTemplate.ts** - **модель шаблонов таблиц с JSON структурой** [НОВОЕ]
- **routes/**: API маршруты
  - authRoutes.ts - маршруты аутентификации (/api/auth)
  - userRoutes.ts - маршруты пользователей (/api/users)
  - roleRoutes.ts - маршруты ролей (/api/roles)
  - groupRoutes.ts - маршруты групп (/api/groups)
  - sheetRoutes.ts - маршруты таблиц (/api/sheets) + добавление строк/столбцов, resize, участники
  - cellRoutes.ts - маршруты ячеек (/api/cells) + история, форматирование
  - **sheetTemplateRoutes.ts** - **маршруты шаблонов (/api/templates)** [НОВОЕ]
- **middleware/**: Промежуточное ПО
  - auth.ts - аутентификация JWT, проверка ролей и разрешений
- **websocket/**: Real-time функционал
  - socketHandlers.ts - обработчики WebSocket для совместной работы

### Frontend (/frontend)
- **components/**: React компоненты
  - PrivateRoute.tsx - защищенные маршруты
  - Spreadsheet/ - РАСШИРЕННЫЕ компоненты таблицы
    - Spreadsheet.tsx - основной компонент таблицы с форматированием, выделением диапазонов, изменением размеров
    - Cell.tsx - компонент отдельной ячейки с поддержкой форматирования и настраиваемых размеров
    - FormatToolbar.tsx - панель инструментов форматирования
    - CellHistoryDialog.tsx - диалог истории изменений ячейки
    - MembersDialog.tsx - диалог управления участниками
- **pages/**: Страницы приложения
  - Login.tsx - страница входа с формами логина/регистрации
  - Dashboard.tsx - **главная страница со списком таблиц и новым диалогом создания с поддержкой шаблонов** [ЗНАЧИТЕЛЬНО РАСШИРЕНО]
  - Sheet.tsx - страница работы с таблицей с интегрированными кнопками "Участники" и "Поделиться"
  - AdminPanel.tsx - панель администратора с вкладками управления
- **components/Admin/**: Компоненты панели администратора
  - UserManagement.tsx - управление пользователями (создание, приглашения, массовые операции)
  - GroupManagement.tsx - управление группами пользователей (создание, управление участниками)
  - AccessControl.tsx - детальные права доступа (на уровне ячеек/строк/столбцов, копирование прав)
- **store/**: Redux store (Redux Toolkit)
  - index.ts - конфигурация store
  - authSlice.ts - состояние аутентификации и async thunks
  - sheetSlice.ts - состояние таблиц
  - userSlice.ts - состояние пользователей
- **services/**: API и WebSocket сервисы
  - api.ts - **HTTP клиент с interceptors для всех API endpoints + templatesApi методы** [РАСШИРЕНО]
  - websocket.ts - WebSocket сервис для real-time функций
- **types/**: TypeScript типы
  - index.ts - **общие типы данных и API responses + типы SheetTemplate** [РАСШИРЕНО]
- **public/**: Статические файлы
  - index.html - HTML шаблон приложения

### База данных
- **MySQL**: Основное хранилище данных
- **Таблицы**:
  - users - пользователи
  - roles - роли
  - permissions - разрешения
  - sheets - таблицы + настройки размеров + **template_id для связи с шаблоном**
  - cells - ячейки + расширенное форматирование
  - cell_history - история изменений ячеек
  - user_sheets - связи пользователей с таблицами
  - role_permissions - связи ролей с разрешениями
  - **sheet_templates - шаблоны таблиц с JSON структурой** [НОВОЕ]

## Технологический стек

### Backend
- Node.js + Express + TypeScript
- Sequelize ORM для работы с MySQL
- Socket.io для real-time
- JWT для аутентификации
- bcrypt для хеширования паролей

### Frontend  
- React + TypeScript (5.8.3)
- Redux Toolkit для state management
- Material-UI v7.1.1 для UI компонентов
- Socket.io-client для real-time
- Axios для HTTP запросов
- date-fns для форматирования дат
- lodash для debounce

### DevOps
- Docker + Docker Compose (Production Mode Only)
- MySQL 8.0
- Nginx для reverse proxy и статических файлов

## Основные функции

### 1. Аутентификация и авторизация
- Регистрация/вход пользователей
- JWT токены
- Приглашения пользователей
- Система ролей и разрешений
- **Автоматическое создание администратора при запуске сервера**
- **Расширенные функции администратора:**
  - Создание пользователей с временными паролями
  - Массовые операции с пользователями
  - Создание и управление группами пользователей
  - Приглашения пользователей с токенами
  - Настройка детальных прав доступа к ячейкам/столбцам/строкам

### 2. Управление таблицами [ЗНАЧИТЕЛЬНО РАСШИРЕНО]
- Создание, редактирование, удаление таблиц
- **✅ НОВОЕ: Система шаблонов таблиц:**
  - **Предустановленные шаблоны для разных типов бизнеса**
  - **✅ ИСПРАВЛЕНА КОДИРОВКА: Проблема с отображением русских символов полностью устранена**
  - **Готовые шаблоны для гостиничного бизнеса DMD Cottage:**
    - **"Журнал заселения DMD Cottage"** - таблица учета заселения и выселения гостей (12 колонок: Месяц, Дата заселения, Кол-во дней, Дата выселения, ФИО, Телефон, Общая сумма проживания, Предоплата (сумма аванса), Доплата за проживание в день заселения, Статус дома, Источник, Комментарий по оплате и проживанию)
    - **"Отчет заселения/выселения DMD Cottage"** - ежедневный отчет о заселениях и выселениях (16 колонок с разделением на секции выселения и заселения)
  - **JSON-структура шаблонов с предустановленными заголовками, форматированием и примерами данных**
  - **✅ Полные примеры данных из реальных кейсов DMD Cottage (8 строк данных в первом шаблоне)**
  - **Визуальный выбор шаблонов в UI с предпросмотром**
  - **Автоматическое создание ячеек и применение форматирования при создании из шаблона**
- **Расширенные функции работы с ячейками:**
  - **Полноценное форматирование текста:** шрифт, размер, стили (жирный, курсив, подчеркнутый)
  - **Форматирование границ:** все границы, внешние, внутренние с настройкой стиля и цвета
  - **Цветовое форматирование:** цвет текста и фона ячеек
  - **Выравнивание текста:** по левому краю, центру, правому краю
- **Управление структурой таблицы:**
  - **Добавление новых строк и столбцов** с кнопками в панели инструментов
  - **Изменение размеров ячеек:** drag&drop resize для столбцов и строк
  - **Сохранение пользовательских размеров** в настройках таблицы
- **Выделение диапазонов ячеек** для массового применения форматирования
- Формулы в ячейках
- Объединение ячеек

### 3. **История и аудит изменений** [НОВОЕ]
- **Полная история изменений каждой ячейки:**
  - Отслеживание изменений значений, формул и форматирования
  - Информация о пользователе, внесшем изменения
  - Временные метки всех изменений
  - Типизированные изменения (создание, значение, формула, форматирование, удаление)
- **Удобный интерфейс просмотра истории:**
  - Диалог истории для каждой ячейки
  - Цветовая индикация типов изменений
  - Детальная информация о форматировании

### 4. **Управление участниками** [ПОЛНОСТЬЮ РЕАЛИЗОВАНО]
- **Кнопка "Участники"** - доступна всем пользователям для просмотра списка участников
- **Кнопка "Поделиться"** - доступна администраторам для приглашения новых участников
- **Диалог управления участниками:**
  - Просмотр всех участников таблицы с их ролями
  - Приглашение новых участников по email
  - Настройка прав доступа (чтение, редактирование, администрирование)
  - Цветовые индикаторы ролей участников

### 5. Совместная работа
- Real-time синхронизация изменений
- Отображение активных пользователей
- Блокировка ячеек при редактировании

### 6. Система разрешений
- Создание пользовательских ролей
- Назначение разрешений на уровне столбцов/строк
- Контроль доступа к функциям

### 7. Расширенные админ функции
- **Панель администратора с полноценным UI:** `AdminPanel.tsx` с вкладками управления
- **Управление пользователями:** Компонент `UserManagement.tsx`
- **Управление группами:** Компонент `GroupManagement.tsx`
- **Детальные права доступа:** Компонент `AccessControl.tsx`

## Статус проекта

✅ **Completed**: Проект полностью настроен и готов к запуску
- Backend API с полным функционалом (Node.js + Express + TypeScript)
- Frontend с основными компонентами (React + Material-UI)
- **Полноценная система работы с таблицами** [ОБНОВЛЕНО]
- **Расширенная панель инструментов форматирования** [НОВОЕ]
- **Система истории изменений ячеек** [НОВОЕ]  
- **Управление участниками и совместный доступ** [НОВОЕ]
- **Динамическое изменение размеров ячеек** [НОВОЕ]
- **Выделение и массовое форматирование диапазонов** [НОВОЕ]
- **✅ НОВОЕ: Полная система шаблонов таблиц для DMD Cottage** [18.12.2024]
- База данных со схемой и начальными данными (MySQL 8.0)
- **Система разрешений с 23 базовыми правами доступа**

### Новая функциональность шаблонов (дек 2024) - **ГОТОВЫЕ ШАБЛОНЫ ДЛЯ ГОСТИНИЧНОГО БИЗНЕСА**
- **✅ Модель SheetTemplate**: JSON-структура с заголовками, примерами данных, настройками ширины колонок и форматированием
- **✅ API endpoints**: `/api/templates` для получения списка шаблонов и создания таблиц из шаблонов
- **✅ Два готовых шаблона для DMD Cottage**:
  - **"Журнал заселения DMD Cottage"** (12 колонок) - основной журнал учета гостей с полным циклом от заселения до выселения
  - **"Отчет заселения/выселения DMD Cottage"** (16 колонок) - ежедневный отчет с разделением на секции выселения и заселения
- **✅ Обновленный UI создания таблиц**: 
  - Новый диалог с вкладками "Пустая таблица" и "Из шаблона"
  - Визуальные карточки шаблонов с категориями
  - Предпросмотр и настройка перед созданием
- **✅ Автоматическое применение структуры**: При создании из шаблона автоматически создаются ячейки с заголовками, примерами данных и применяется форматирование
- **✅ Интеграция в Dashboard**: Отображение метки шаблона на созданных таблицах

### Недавние обновления (дек 2024) - **РАСШИРЕННАЯ ФУНКЦИОНАЛЬНОСТЬ ТАБЛИЦ**
- **✅ Форматирование текста и границ ячеек**: Реализована полная панель инструментов с выбором шрифтов, размеров, стилей, цветов и границ
- **✅ История изменений ячеек**: Создана модель CellHistory, API endpoints, диалог просмотра истории с детализацией типов изменений
- **✅ Кнопки участники и поделиться**: Полностью функциональные кнопки с диалогом управления участниками и приглашениями
- **✅ Добавление новых столбцов и строк**: API endpoints и UI кнопки для динамического расширения таблицы
- **✅ Изменение размеров ячеек**: Drag&drop resize для столбцов и строк с сохранением в настройках таблицы
- **✅ Выделение диапазонов ячеек**: Поддержка выделения мышью для массового применения форматирования
- **✅ Интеграция всех компонентов**: Все новые функции интегрированы в основной Spreadsheet компонент

### Исправленные проблемы
- **Backend TypeScript ошибки**: Исправлена типизация `jwt.sign()` и добавлено обязательное поле `isActive: true` при создании пользователей
- **Frontend совместимость**: Понижена версия TypeScript с ^5.3.3 до ^4.9.5 для совместимости с react-scripts 5.0.1
- **Автоматическое создание администратора**: Добавлена система автоматической инициализации администратора из переменных окружения при первом запуске сервера
- **CORS настройки**: Исправлены настройки CORS в backend для поддержки множественных origins (localhost, localhost:3000)
- **Docker Nginx конфигурация**: Создана правильная конфигурация nginx для проксирования запросов к API и frontend
- **React proxy конфликт**: Удалена конфликтующая настройка proxy из package.json frontend
- **Express trust proxy**: Настроено доверие к nginx прокси для корректной работы express-rate-limit с заголовками X-Forwarded-For
- **Sequelize ассоциации**: Исправлены прямые ассоциации между UserSheet/RolePermission и связанными моделями для корректного include в запросах
- **Все проблемы с функциональностью таблиц устранены**: форматирование, история, участники, добавление строк/столбцов, изменение размеров - все работает
- **✅ КРИТИЧЕСКИЕ ИСПРАВЛЕНИЯ (дек 2024)**:
  - **Редактирование пользователей**: Добавлены функции `handleEditUser`, `openEditDialog` и полный диалог редактирования в `UserManagement.tsx`
  - **Авторизация созданных пользователей**: Добавлено хеширование паролей `bcrypt` в `userController.ts` при создании пользователей
  - **Роль 'user' в базе данных**: Создана роль 'user' с ID=2 для корректной работы создания пользователей
  - **Сохранение прав групп**: Исправлен HTTP метод с PATCH на PUT в `GroupManagement.tsx` для корректного обновления групп
  - ✅ **ПОЛНОСТЬЮ ПРОТЕСТИРОВАНО через Playwright**:
    - Успешная авторизация через https://nginx.raznaradki-from-gs.orb.local/login
    - Корректная работа диалога CellHistoryDialog 
    - Исправлена ошибка Sequelize ассоциаций (алиас 'changedByUser' в контроллере)
    - Пересборка backend с обновленным TypeScript кодом
    - ✅ **API истории изменений работает идеально**:
      - Endpoint /api/cells/sheets/{id}/cells/{row}/{column}/history возвращает 200 OK
      - Полная история с 11 записями изменений
      - Корректные данные пользователей (changedByUser) 
      - Все типы изменений (create, format, formula, value)
- ✅ **ФИНАЛЬНЫЕ ИСПРАВЛЕНИЯ 18.06.2025**:
  - ✅ **Редактирование ячеек по одному клику**: Изменена логика в handleCellClick - первый клик выбирает ячейку, второй клик на выбранную ячейку начинает редактирование
  - ✅ **Правильное отображение изменений значений в истории**: Исправлена логика определения типа изменений в cellController.ts - теперь корректно различаются изменения значений, формул и форматирования
  - ✅ **Автосохранение значений ячеек**: Добавлены обработчики onBlur для автосохранения при потере фокуса и Tab для перехода к следующей ячейке с сохранением значения
  - ✅ **Исправление дубликатов в истории**: Добавлена проверка изменения значений в setCellValue - записи в историю добавляются только при реальных изменениях
  - ✅ **Поддержка Excel-формул**: Реализован полнофункциональный движок FormulaEngine (frontend/src/utils/formulaEngine.ts) с поддержкой:
    - Ссылки на ячейки (A1, B2)
    - Диапазоны ячеек (A1:B5)  
    - Математические операторы (+, -, *, /)
    - Функции: SUM, AVERAGE, MIN, MAX, COUNT, IF, ROUND, ABS, SQRT, POWER
    - Безопасное вычисление с обработкой ошибок
  - ✅ **Все функции полностью протестированы через Playwright**: 
    - Редактирование по одному клику работает корректно
    - Автосохранение при клике на другую ячейку функционирует правильно
    - Tab переходит к следующей ячейке с автосохранением текущей
    - История показывает все типы изменений без дубликатов: значения ("Было: X" → "Стало: Y"), формулы, форматирование, создание
    - Excel-формулы работают: =A1+A2, =SUM(A1:A3) корректно вычисляются и отображаются
    - Формулы отображаются в режиме редактирования, результаты в режиме просмотра

## Безопасность и обновления

### Исправленные уязвимости (последнее обновление)
- ✅ **Обновлен TypeScript**: с версии 3.2.1 до 5.8.3 для улучшения типизации и безопасности
- ✅ **Исправлены уязвимости зависимостей**: применены overrides для принудительного обновления уязвимых пакетов
  - nth-check обновлен до ^2.1.1 (исправлена высокая уязвимость)
  - postcss обновлен до ^8.4.31 (исправлена средняя уязвимость)
  - webpack-dev-server обновлен до ^5.2.1 (исправлена средняя уязвимость)
- ✅ **Обновлен Material-UI Grid API**: переход на новый API Grid v2 с size props
- ✅ **NPM Audit Clean**: 0 уязвимостей

### Исправленные проблемы продакшена (WebSocket/API)
- ✅ **WebSocket подключения**: исправлена конфигурация для HTTPS окружений
- ✅ **Mixed Content блокировка**: API и WebSocket теперь используют относительные URL в продакшене
- ✅ **CORS ошибки**: добавлена поддержка orb.local доменов в backend
- ✅ **HTTPS поддержка**: обновлена nginx конфигурация для SSL терминации
- ✅ **Безопасность заголовков**: добавлены security headers и HSTS

### Используемые версии зависимостей
- React: 19.1.0
- TypeScript: 5.8.3
- Material-UI: 7.1.1
- Redux Toolkit: 2.8.1

## Запуск проекта

### Быстрый запуск через Docker Compose

1. **Автоматический запуск**:
   ```bash
   ./start.sh
   ```

2. **Ручной запуск**:
   ```bash
   # Создать .env файл (если нет)
   cp env.example .env
   
   # Настроить данные администратора в .env (опционально)
   # ADMIN_EMAIL=admin@dmdcottage.com
   # ADMIN_PASSWORD=admin123456
   # ADMIN_FIRST_NAME=Администратор
   # ADMIN_LAST_NAME=Системы
   
   # Запустить все сервисы
   docker-compose up -d
   
   # Проверить статус
   docker-compose ps
   ```