# Архитектура DMD Cottage Sheets

## Обзор проекта
Веб-сервис для совместной работы с таблицами, аналог Google Sheets для компании DMD cottage.
Сервис запускается через docker compose.

## Структура проекта

```
raznaradki_from_gs/
├── backend/                    # Backend API на Node.js + Express
│   ├── src/
│   │   ├── controllers/        # Контроллеры API
│   │   ├── models/            # Модели базы данных (Sequelize)
│   │   ├── routes/            # Маршруты API
│   │   ├── middleware/        # Middleware для аутентификации и авторизации
│   │   ├── services/          # Бизнес-логика
│   │   ├── utils/             # Утилиты и хелперы
│   │   │   └── initAdmin.ts  # Автоматическая инициализация администратора
│   │   ├── websocket/         # WebSocket для real-time
│   │   └── app.ts            # Основной файл приложения
│   ├── package.json
│   ├── tsconfig.json
│   └── Dockerfile
├── frontend/                   # Frontend на React + TypeScript
│   ├── src/
│   │   ├── components/        # React компоненты
│   │   ├── pages/            # Страницы приложения
│   │   ├── hooks/            # Custom hooks
│   │   ├── services/         # API сервисы
│   │   ├── store/            # State management (Redux Toolkit)
│   │   ├── types/            # TypeScript типы
│   │   └── utils/            # Утилиты
│   ├── package.json
│   ├── tsconfig.json
│   └── Dockerfile
├── database/                   # Скрипты и схемы БД
│   ├── migrations/           # Миграции базы данных
│   ├── seeds/               # Начальные данные
│   └── schema.sql           # Схема базы данных
├── docker-compose.yml         # Конфигурация Docker Compose
├── .env.example              # Пример переменных окружения
└── README.md                 # Документация проекта

## Основные компоненты

### Backend (/backend)
- **app.ts**: Точка входа, настройка Express сервера, middleware, Socket.io, инициализация админа
- **controllers/**: Обработчики HTTP запросов
  - authController.ts - аутентификация, регистрация и приглашения пользователей
  - userController.ts - управление пользователями (CRUD, деактивация)
  - roleController.ts - управление ролями и разрешениями
  - sheetController.ts - работа с таблицами (создание, редактирование, доступ)
  - cellController.ts - операции с ячейками (обновление, формулы)
- **models/**: Модели данных для Sequelize ORM
  - index.ts - конфигурация Sequelize и настройка ассоциаций
  - User.ts - модель пользователя с аутентификацией
  - Role.ts - модель роли (системные и пользовательские)
  - Permission.ts - модель разрешений (resource + action)
  - Sheet.ts - модель таблицы с настройками и метаданными
  - Cell.ts - модель ячейки с поддержкой формул и форматирования
  - UserSheet.ts - связь пользователя с таблицей + разрешения на строки/столбцы
  - RolePermission.ts - связь ролей с разрешениями
- **routes/**: API маршруты
  - authRoutes.ts - маршруты аутентификации (/api/auth)
  - userRoutes.ts - маршруты пользователей (/api/users)
  - roleRoutes.ts - маршруты ролей (/api/roles)
  - sheetRoutes.ts - маршруты таблиц (/api/sheets)
  - cellRoutes.ts - маршруты ячеек (/api/cells)
- **middleware/**: Промежуточное ПО
  - auth.ts - аутентификация JWT, проверка ролей и разрешений
- **websocket/**: Real-time функционал
  - socketHandlers.ts - обработчики WebSocket для совместной работы

### Frontend (/frontend)
- **components/**: React компоненты
  - PrivateRoute.tsx - защищенные маршруты
  - Spreadsheet/ - компоненты таблицы
    - Spreadsheet.tsx - основной компонент таблицы с grid
    - Cell.tsx - компонент отдельной ячейки с редактированием
- **pages/**: Страницы приложения
  - Login.tsx - страница входа с формами логина/регистрации
  - Dashboard.tsx - главная страница со списком таблиц
  - Sheet.tsx - страница работы с таблицей
- **store/**: Redux store (Redux Toolkit)
  - index.ts - конфигурация store
  - authSlice.ts - состояние аутентификации и async thunks
  - sheetSlice.ts - состояние таблиц
  - userSlice.ts - состояние пользователей
- **services/**: API и WebSocket сервисы
  - api.ts - HTTP клиент с interceptors для всех API endpoints
  - websocket.ts - WebSocket сервис для real-time функций
- **types/**: TypeScript типы
  - index.ts - общие типы данных и API responses
- **public/**: Статические файлы
  - index.html - HTML шаблон приложения

### База данных
- **MySQL**: Основное хранилище данных
- **Таблицы**:
  - users - пользователи
  - roles - роли
  - permissions - разрешения
  - sheets - таблицы
  - cells - ячейки
  - user_sheets - связи пользователей с таблицами
  - role_permissions - связи ролей с разрешениями

## Технологический стек

### Backend
- Node.js + Express + TypeScript
- Sequelize ORM для работы с MySQL
- Socket.io для real-time
- JWT для аутентификации
- bcrypt для хеширования паролей

### Frontend  
- React + TypeScript
- Redux Toolkit для state management
- Material-UI для UI компонентов
- Socket.io-client для real-time
- Axios для HTTP запросов

### DevOps
- Docker + Docker Compose
- MySQL 8.0
- Nginx для reverse proxy

## Основные функции

### 1. Аутентификация и авторизация
- Регистрация/вход пользователей
- JWT токены
- Приглашения пользователей
- Система ролей и разрешений
- **Автоматическое создание администратора при запуске сервера**

### 2. Управление таблицами
- Создание, редактирование, удаление таблиц
- Формулы в ячейках
- Объединение ячеек
- Форматирование

### 3. Совместная работа
- Real-time синхронизация изменений
- Отображение активных пользователей
- Блокировка ячеек при редактировании

### 4. Система разрешений
- Создание пользовательских ролей
- Назначение разрешений на уровне столбцов/строк
- Контроль доступа к функциям

### 5. **✅ СИСТЕМА СВЯЗАННЫХ ТАБЛИЦ для автоматической синхронизации:**
- **Отчеты автоматически обновляются при изменении данных в исходных журналах**
- **Поле `sourceSheetId` в модели Sheet для связи между таблицами**
- **API endpoint `/api/templates/sync/:reportSheetId/:sourceSheetId` для синхронизации**
- **Автоматическое обновление связанных отчетов при изменении ячеек в журналах**

### 6. **✅ ФУНКЦИОНАЛ ВЫБОРА ИСХОДНОЙ ТАБЛИЦЫ:**
- **Выпадающий список для выбора журнала заселения при создании отчета**
- **Опция "Не связывать" для создания независимого отчета**
- **Автоматическая фильтрация доступных журналов по типу шаблона**

### 7. **✅ ПОЛНОСТЬЮ РЕАЛИЗОВАННАЯ СИСТЕМА АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИИ ОТЧЕТОВ (28.01.2025):**
- **✅ Поле `reportDate` в модели Sheet для хранения даты отчета**
- **✅ UI компонент выбора даты в интерфейсе отчетов с календарем и чипом "Связанный отчет"**
- **✅ Автоматическая фильтрация данных журнала по выбранной дате с правильным преобразованием форматов дат**
- **✅ API endpoint `/api/templates/update-report-date/:sheetId` для обновления даты**
- **✅ Мгновенная пересинхронизация отчета при изменении даты с автоматическим обновлением интерфейса**
- **✅ Корректное отображение данных о заселении и выселении только на выбранную дату**
- **✅ Автоматическое преобразование формата дат DD.MM.YYYY (журнал) в YYYY-MM-DD (отчет)**
- **✅ Логика фильтрации: включает записи где дата заселения ИЛИ выселения совпадает с датой отчета**
- **✅ Правильное разделение данных на секции "Выселение" и "Заселение" в отчете**
- **✅ Автоматическое обновление связанных отчетов при изменении ячеек в журналах через cellController**
- **✅ ИСПРАВЛЕНА ГРУППИРОВКА ДАННЫХ: Выселение и заселение в один день теперь отображаются в одной строке отчета (28.01.2025)**
- **✅ Новая логика `transformJournalToReport`: группирует данные по адресам, объединяя операции выселения и заселения**
- **✅ Динамический адрес: адрес отчета извлекается из названия журнала (например "DMD Cottage" из "Журнал заселения DMD Cottage")**
- **✅ Правильный статус дома: "Выс/Зас" для строк с обеими операциями, "Выселение"/"Заселение" для отдельных операций**
- **✅ Backend обновлен с асинхронной логикой transformJournalToReport для корректной работы с базой данных**

### 8. **✅ СИСТЕМА МНОЖЕСТВЕННЫХ СВЯЗЕЙ ЖУРНАЛОВ С ОТЧЕТАМИ ПОЛНОСТЬЮ РЕАЛИЗОВАНА (29.01.2025):**
- **✅ Создана модель `ReportSource` для связи many-to-many между отчетами и журналами**
- **✅ Создана таблица `report_sources` для хранения связей с уникальными индексами**
- **✅ Миграция 005_add_report_sources.sql для создания новой таблицы и переноса существующих связей**
- **✅ Обновлены ассоциации Sequelize для поддержки множественных связей через ReportSource**
- **✅ Новая функция `syncLinkedSheetDataFromMultipleSources()` для синхронизации с несколькими журналами**
- **✅ API endpoints для управления связями:**
  - `GET /api/templates/report-sources/:sheetId` - получение связанных журналов
  - `POST /api/templates/report-sources/:sheetId` - добавление связи с журналом
  - `DELETE /api/templates/report-sources/:sheetId/:sourceSheetId` - удаление связи
- **✅ UI компонент `JournalSelector` с множественным выбором через Autocomplete с чипами**
- **✅ ИСПРАВЛЕНА ПРОБЛЕМА С ПОЛЕМ ВЫБОРА ДАТЫ ОТЧЕТА:**
  - Исправлено условие `isLinkedReport` в `Sheet.tsx` для корректного отображения поля даты
  - Поле выбора даты теперь отображается для всех отчетов (шаблоны с названием "Отчет")
  - Чип "Связанные журналы" корректно отображается в интерфейсе
- **✅ ИСПРАВЛЕНА ЛОГИКА ОТОБРАЖЕНИЯ НАЗВАНИЙ ТАБЛИЦ В КОЛОНКЕ "АДРЕС":**
  - В колонке "Адрес" теперь отображается полное название журнала-источника
  - Например: "Журнал заселения DMD Cottage" вместо извлеченного адреса
  - Улучшена группировка данных с уникальным ключом: название журнала + ФИО + индекс строки
  - Это позволяет отображать записи из разных журналов как отдельные строки
- **✅ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ СИНХРОНИЗАЦИИ ДАННЫХ ИЗ МНОЖЕСТВЕННЫХ ЖУРНАЛОВ (29.01.2025):**
  - Исправлена проблема с потерей информации об источнике данных при фильтрации
  - Добавлено сохранение `sourceSheetId` и `sourceSheetName` для каждой ячейки при фильтрации
  - Обновлена логика группировки в `transformJournalToReport` для использования корректной информации об источнике
  - Исправлен уникальный ключ группировки: `${sourceSheetId}:${tableName}:${guestName}`
  - Добавлена отладочная информация для диагностики синхронизации
  - **✅ ИСПРАВЛЕНА ГРУППИРОВКА ЯЧЕЕК:** изменена логика группировки с использованием `sourceSheetId:row` для предотвращения перезаписи данных из разных журналов
  - **✅ ИСПРАВЛЕНО СОХРАНЕНИЕ ИНДЕКСОВ:** добавлено явное сохранение `parseInt(rowIndex)` и `parseInt(colIndex)` при копировании ячеек
  - **✅ ИСПРАВЛЕНО СОХРАНЕНИЕ ЗНАЧЕНИЙ:** добавлено явное сохранение `value: cell.value` при копировании ячеек
  - **✅ РЕЗУЛЬТАТ:** система создает 32 ячейки для отчета из 2 журналов и корректно отображает данные из всех связанных источников
- **✅ Протестировано через Playwright:**
  - Поле выбора даты отчета отображается корректно
  - UI компонент выбора нескольких журналов работает
  - Создание отчетов с множественными связями функционирует
  - Синхронизация данных из множественных источников работает правильно

### 9. **✅ ПОЛНОСТЬЮ ПЕРЕРАБОТАНА СИСТЕМА ВЫДЕЛЕНИЯ ЯЧЕЕК (29.01.2025):**
- **✅ Предотвращение текстового выделения:** Добавлены CSS свойства `user-select: none` во всех компонентах таблицы
- **✅ Улучшенная визуализация:** Выделенные ячейки теперь имеют тени и улучшенные границы для лучшей видимости
- **✅ Полная клавиатурная навигация:**
  - Стрелки (↑↓←→) для перемещения между ячейками
  - Enter для начала редактирования выделенной ячейки
  - Delete/Backspace для очистки содержимого выделенных ячеек
  - Escape для снятия выделения и выхода из режима редактирования
- **✅ Улучшенная обработка мыши:** Добавлен `preventDefault()` для предотвращения выделения текста браузером
- **✅ Фокус на таблице:** Таблица может получать фокус для работы клавиатурной навигации
- **✅ Интеллектуальный hover:** Эффект наведения работает только для невыделенных ячеек
- **✅ Результат:** Выделение ячеек теперь работает только через интерфейс приложения (клики мыши, клавиатура), а не как обычное текстовое выделение браузера

### 10. **✅ СИСТЕМА КОПИРОВАНИЯ И ВСТАВКИ ЯЧЕЕК С УЛУЧШЕНИЯМИ (29.01.2025) - ПРОТЕСТИРОВАНО:**
- **✅ Полный буфер обмена:** Реализована система внутреннего буфера для сохранения скопированных/вырезанных ячеек
- **✅ Горячие клавиши:**
  - Ctrl+C для копирования выделенных ячеек
  - Ctrl+X для вырезания выделенных ячеек (с очисткой исходных)
  - Ctrl+V для вставки из буфера обмена
- **✅ Поддержка системного буфера:** Данные копируются в формате TSV для совместимости с внешними приложениями
- **✅ Визуальная индикация:** Скопированные ячейки отображаются с оранжевой пунктирной границей
- **✅ Сохранение форматирования:** При копировании/вставке сохраняются значения, формулы и форматирование ячеек
- **✅ Интеллектуальная вставка:** 
  - Поддерживает вставку из внутреннего буфера с полным форматированием
  - Поддерживает вставку текста из системного буфера в формате TSV
  - Автоматическая проверка границ таблицы при вставке
- **✅ Операции вырезания:** Автоматическая очистка буфера после вставки вырезанных ячеек
- **✅ УЛУЧШЕННАЯ ВСТАВКА ИЗ ВНЕШНИХ ИСТОЧНИКОВ:**
  - Расширенная поддержка разделителей (табуляция, запятая, точка с запятой)
  - Автоматическая очистка кавычек и пробелов
  - Capture фаза для paste событий для улучшенной обработки
  - Детальное логирование процесса вставки для отладки
- **✅ АВТОСОХРАНЕНИЕ ДАННЫХ ПРОТЕСТИРОВАНО:** Функция handleEditBlur автоматически сохраняет данные при потере фокуса ячейки, логирование подтверждает работу
- **✅ УЛУЧШЕННАЯ ОБРАБОТКА ESCAPE ПРОТЕСТИРОВАНА:** При нажатии Escape происходит полная очистка выделения И буфера обмена, работает во всех режимах
- **✅ РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ ЧЕРЕЗ PLAYWRIGHT:** Автосохранение и Escape работают корректно, система готова к использованию

## Статус проекта

✅ **Completed**: Проект полностью настроен и готов к запуску
- Backend API с полным функционалом (Node.js + Express + TypeScript)
- Frontend с основными компонентами (React + Material-UI)
- База данных со схемой и начальными данными (MySQL 8.0)
- **Docker Compose конфигурация для разработки и продакшена**
- WebSocket для real-time совместной работы
- Nginx reverse proxy для маршрутизации
- Автоматические скрипты запуска

🚀 **Проект готов к использованию!**

## Запуск проекта

### Быстрый запуск через Docker Compose

1. **Автоматический запуск**:
   ```bash
   ./start.sh
   ```

2. **Ручной запуск**:
   ```bash
   # Создать .env файл (если нет)
   cp env.example .env
   
   # Настроить данные администратора в .env (опционально)
   # ADMIN_EMAIL=admin@dmdcottage.com
   # ADMIN_PASSWORD=admin123456
   # ADMIN_FIRST_NAME=Администратор
   # ADMIN_LAST_NAME=Системы
   
   # Запустить все сервисы
   docker-compose up -d
   
   # Проверить статус
   docker-compose ps
   ```

3. **Адреса сервисов**:
   - 🌐 **Приложение**: http://localhost
   - 🔧 **Backend API**: http://localhost:3001  
   - ⚛️ **Frontend**: http://localhost:3000
   - 🗄️ **Adminer (БД)**: http://localhost:8080

### Управление Docker Compose

```bash
# Просмотр логов
docker-compose logs -f

# Остановка сервисов
docker-compose down

# Пересборка контейнеров
docker-compose up -d --build

# Подключение к контейнеру
docker-compose exec backend sh
docker-compose exec frontend sh

# Пересборка и запуск
docker-compose up -d --build

# Запуск с Adminer для управления БД
docker-compose --profile admin up -d
```

## Дополнительные возможности для развития

- Расширенная система формул (как в Excel)
- Импорт/экспорт файлов (XLSX, CSV)
- Комментарии к ячейкам
- История изменений и версионирование
- Уведомления пользователей
- Мобильное приложение
- Интеграция с внешними сервисами

## Исправленные проблемы
- **Backend TypeScript ошибки**: Исправлена типизация `jwt.sign()` и добавлено обязательное поле `isActive: true` при создании пользователей
- **Frontend совместимость**: Понижена версия TypeScript с ^5.3.3 до ^4.9.5 для совместимости с react-scripts 5.0.1
- **Автоматическое создание администратора**: Добавлена система автоматической инициализации администратора из переменных окружения при первом запуске сервера
- **CORS настройки**: Исправлены настройки CORS в backend для поддержки множественных origins (localhost, localhost:3000)
- **Docker Nginx конфигурация**: Создана правильная конфигурация nginx для проксирования запросов к API и frontend
- **React proxy конфликт**: Удалена конфликтующая настройка proxy из package.json frontend

## Новые функции
- **Инициализация администратора**: При запуске сервера автоматически создается пользователь-администратор на основе данных из файла `.env` и переменных окружения Docker Compose
- **Переменные окружения для админа**: 
  - `ADMIN_EMAIL` - email администратора (по умолчанию: admin@dmdcottage.com)
  - `ADMIN_PASSWORD` - пароль администратора (по умолчанию: admin123456)
  - `ADMIN_FIRST_NAME` - имя администратора (по умолчанию: Администратор)
  - `ADMIN_LAST_NAME` - фамилия администратора (по умолчанию: Системы)
- **Docker Compose поддержка**: Переменные администратора автоматически передаются в контейнер backend через docker-compose.yml