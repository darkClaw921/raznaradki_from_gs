# Архитектура DMD Cottage Sheets

## Обзор проекта
Веб-сервис для совместной работы с таблицами, аналог Google Sheets для компании DMD cottage.

## Структура проекта

```
raznaradki_from_gs/
├── backend/                    # Backend API на Node.js + Express
│   ├── src/
│   │   ├── controllers/        # Контроллеры API
│   │   ├── models/            # Модели базы данных (Sequelize)
│   │   ├── routes/            # Маршруты API
│   │   ├── middleware/        # Middleware для аутентификации и авторизации
│   │   ├── services/          # Бизнес-логика
│   │   ├── utils/             # Утилиты и хелперы
│   │   │   └── initAdmin.ts  # Автоматическая инициализация администратора
│   │   ├── websocket/         # WebSocket для real-time
│   │   └── app.ts            # Основной файл приложения
│   ├── package.json
│   ├── tsconfig.json
│   └── Dockerfile
├── frontend/                   # Frontend на React + TypeScript
│   ├── src/
│   │   ├── components/        # React компоненты
│   │   ├── pages/            # Страницы приложения
│   │   ├── hooks/            # Custom hooks
│   │   ├── services/         # API сервисы
│   │   ├── store/            # State management (Redux Toolkit)
│   │   ├── types/            # TypeScript типы
│   │   └── utils/            # Утилиты
│   ├── package.json
│   ├── tsconfig.json
│   └── Dockerfile
├── database/                   # Скрипты и схемы БД
│   ├── migrations/           # Миграции базы данных
│   ├── seeds/               # Начальные данные
│   └── schema.sql           # Схема базы данных
├── docker-compose.yml         # Конфигурация Docker Compose
├── .env.example              # Пример переменных окружения
└── README.md                 # Документация проекта

## Основные компоненты

### Backend (/backend)
- **app.ts**: Точка входа, настройка Express сервера, middleware, Socket.io, инициализация админа
- **controllers/**: Обработчики HTTP запросов
  - authController.ts - аутентификация, регистрация и приглашения пользователей
  - userController.ts - управление пользователями (CRUD, деактивация, создание, массовые операции)
  - roleController.ts - управление ролями и разрешениями
  - groupController.ts - управление группами пользователей
  - sheetController.ts - работа с таблицами (создание, редактирование, доступ, детальные права, добавление строк/столбцов, изменение размеров, управление участниками)
  - cellController.ts - операции с ячейками (обновление, формулы, форматирование, история изменений)
- **models/**: Модели данных для Sequelize ORM
  - index.ts - конфигурация Sequelize и настройка ассоциаций
  - User.ts - модель пользователя с аутентификацией
  - Role.ts - модель роли (системные и пользовательские)
  - Permission.ts - модель разрешений (resource + action)
  - Sheet.ts - модель таблицы с настройками и метаданными (включая размеры столбцов и строк)
  - Cell.ts - модель ячейки с поддержкой формул и расширенного форматирования
  - CellHistory.ts - модель истории изменений ячеек
  - UserSheet.ts - связь пользователя с таблицей + разрешения на строки/столбцы
  - RolePermission.ts - связь ролей с разрешениями
- **routes/**: API маршруты
  - authRoutes.ts - маршруты аутентификации (/api/auth)
  - userRoutes.ts - маршруты пользователей (/api/users)
  - roleRoutes.ts - маршруты ролей (/api/roles)
  - groupRoutes.ts - маршруты групп (/api/groups)
  - sheetRoutes.ts - маршруты таблиц (/api/sheets) + добавление строк/столбцов, resize, участники
  - cellRoutes.ts - маршруты ячеек (/api/cells) + история, форматирование
- **middleware/**: Промежуточное ПО
  - auth.ts - аутентификация JWT, проверка ролей и разрешений
- **websocket/**: Real-time функционал
  - socketHandlers.ts - обработчики WebSocket для совместной работы

### Frontend (/frontend)
- **components/**: React компоненты
  - PrivateRoute.tsx - защищенные маршруты
  - Spreadsheet/ - РАСШИРЕННЫЕ компоненты таблицы
    - Spreadsheet.tsx - основной компонент таблицы с форматированием, выделением диапазонов, изменением размеров
    - Cell.tsx - компонент отдельной ячейки с поддержкой форматирования и настраиваемых размеров
    - FormatToolbar.tsx - панель инструментов форматирования
    - CellHistoryDialog.tsx - диалог истории изменений ячейки
    - MembersDialog.tsx - диалог управления участниками
- **pages/**: Страницы приложения
  - Login.tsx - страница входа с формами логина/регистрации
  - Dashboard.tsx - главная страница со списком таблиц (с кнопкой админ панели для администраторов)
  - Sheet.tsx - страница работы с таблицей с интегрированными кнопками "Участники" и "Поделиться"
  - AdminPanel.tsx - панель администратора с вкладками управления
- **components/Admin/**: Компоненты панели администратора
  - UserManagement.tsx - управление пользователями (создание, приглашения, массовые операции)
  - GroupManagement.tsx - управление группами пользователей (создание, управление участниками)
  - AccessControl.tsx - детальные права доступа (на уровне ячеек/строк/столбцов, копирование прав)
- **store/**: Redux store (Redux Toolkit)
  - index.ts - конфигурация store
  - authSlice.ts - состояние аутентификации и async thunks
  - sheetSlice.ts - состояние таблиц
  - userSlice.ts - состояние пользователей
- **services/**: API и WebSocket сервисы
  - api.ts - HTTP клиент с interceptors для всех API endpoints + новые методы для форматирования, истории, управления структурой
  - websocket.ts - WebSocket сервис для real-time функций
- **types/**: TypeScript типы
  - index.ts - общие типы данных и API responses
- **public/**: Статические файлы
  - index.html - HTML шаблон приложения

### База данных
- **MySQL**: Основное хранилище данных
- **Таблицы**:
  - users - пользователи
  - roles - роли
  - permissions - разрешения
  - sheets - таблицы + настройки размеров
  - cells - ячейки + расширенное форматирование
  - cell_history - история изменений ячеек
  - user_sheets - связи пользователей с таблицами
  - role_permissions - связи ролей с разрешениями

## Технологический стек

### Backend
- Node.js + Express + TypeScript
- Sequelize ORM для работы с MySQL
- Socket.io для real-time
- JWT для аутентификации
- bcrypt для хеширования паролей

### Frontend  
- React + TypeScript (5.8.3)
- Redux Toolkit для state management
- Material-UI v7.1.1 для UI компонентов
- Socket.io-client для real-time
- Axios для HTTP запросов
- date-fns для форматирования дат
- lodash для debounce

### DevOps
- Docker + Docker Compose (Production Mode Only)
- MySQL 8.0
- Nginx для reverse proxy и статических файлов

## Основные функции

### 1. Аутентификация и авторизация
- Регистрация/вход пользователей
- JWT токены
- Приглашения пользователей
- Система ролей и разрешений
- **Автоматическое создание администратора при запуске сервера**
- **Расширенные функции администратора:**
  - Создание пользователей с временными паролями
  - Массовые операции с пользователями
  - Создание и управление группами пользователей
  - Приглашения пользователей с токенами
  - Настройка детальных прав доступа к ячейкам/столбцам/строкам

### 2. Управление таблицами [ЗНАЧИТЕЛЬНО РАСШИРЕНО]
- Создание, редактирование, удаление таблиц
- **Расширенные функции работы с ячейками:**
  - **Полноценное форматирование текста:** шрифт, размер, стили (жирный, курсив, подчеркнутый)
  - **Форматирование границ:** все границы, внешние, внутренние с настройкой стиля и цвета
  - **Цветовое форматирование:** цвет текста и фона ячеек
  - **Выравнивание текста:** по левому краю, центру, правому краю
- **Управление структурой таблицы:**
  - **Добавление новых строк и столбцов** с кнопками в панели инструментов
  - **Изменение размеров ячеек:** drag&drop resize для столбцов и строк
  - **Сохранение пользовательских размеров** в настройках таблицы
- **Выделение диапазонов ячеек** для массового применения форматирования
- Формулы в ячейках
- Объединение ячеек

### 3. **История и аудит изменений** [НОВОЕ]
- **Полная история изменений каждой ячейки:**
  - Отслеживание изменений значений, формул и форматирования
  - Информация о пользователе, внесшем изменения
  - Временные метки всех изменений
  - Типизированные изменения (создание, значение, формула, форматирование, удаление)
- **Удобный интерфейс просмотра истории:**
  - Диалог истории для каждой ячейки
  - Цветовая индикация типов изменений
  - Детальная информация о форматировании

### 4. **Управление участниками** [ПОЛНОСТЬЮ РЕАЛИЗОВАНО]
- **Кнопка "Участники"** - доступна всем пользователям для просмотра списка участников
- **Кнопка "Поделиться"** - доступна администраторам для приглашения новых участников
- **Диалог управления участниками:**
  - Просмотр всех участников таблицы с их ролями
  - Приглашение новых участников по email
  - Настройка прав доступа (чтение, редактирование, администрирование)
  - Цветовые индикаторы ролей участников

### 5. Совместная работа
- Real-time синхронизация изменений
- Отображение активных пользователей
- Блокировка ячеек при редактировании

### 6. Система разрешений
- Создание пользовательских ролей
- Назначение разрешений на уровне столбцов/строк
- Контроль доступа к функциям

### 7. Расширенные админ функции
- **Панель администратора с полноценным UI:** `AdminPanel.tsx` с вкладками управления
- **Управление пользователями:** Компонент `UserManagement.tsx`
- **Управление группами:** Компонент `GroupManagement.tsx`
- **Детальные права доступа:** Компонент `AccessControl.tsx`

## Статус проекта

✅ **Completed**: Проект полностью настроен и готов к запуску
- Backend API с полным функционалом (Node.js + Express + TypeScript)
- Frontend с основными компонентами (React + Material-UI)
- **Полноценная система работы с таблицами** [ОБНОВЛЕНО]
- **Расширенная панель инструментов форматирования** [НОВОЕ]
- **Система истории изменений ячеек** [НОВОЕ]  
- **Управление участниками и совместный доступ** [НОВОЕ]
- **Динамическое изменение размеров ячеек** [НОВОЕ]
- **Выделение и массовое форматирование диапазонов** [НОВОЕ]
- База данных со схемой и начальными данными (MySQL 8.0)
- **Система разрешений с 23 базовыми правами доступа**

### Недавние обновления (дек 2024) - **РАСШИРЕННАЯ ФУНКЦИОНАЛЬНОСТЬ ТАБЛИЦ**
- **✅ Форматирование текста и границ ячеек**: Реализована полная панель инструментов с выбором шрифтов, размеров, стилей, цветов и границ
- **✅ История изменений ячеек**: Создана модель CellHistory, API endpoints, диалог просмотра истории с детализацией типов изменений
- **✅ Кнопки участники и поделиться**: Полностью функциональные кнопки с диалогом управления участниками и приглашениями
- **✅ Добавление новых столбцов и строк**: API endpoints и UI кнопки для динамического расширения таблицы
- **✅ Изменение размеров ячеек**: Drag&drop resize для столбцов и строк с сохранением в настройках таблицы
- **✅ Выделение диапазонов ячеек**: Поддержка выделения мышью для массового применения форматирования
- **✅ Интеграция всех компонентов**: Все новые функции интегрированы в основной Spreadsheet компонент

### Исправленные проблемы
- **Исправлена проблема создания пользователя**: добавлен выбор роли в форме создания
- **Исправлена проблема создания группы**: убрано требование обязательного списка пользователей
- **Исправлены проверки ролей**: заменены названия ролей для корректной работы с базой данных
- **Добавлена поддержка API ролей**: создан endpoint `/api/roles`
- **Исправлена проблема создания правил доступа**: исправлена логика получения sheetId
- **Обновлена обработка cellRange**: добавлена поддержка диапазонов ячеек
- **Добавлено управление правами доступа для групп**
- **Docker Compose конфигурация для продакшена (Production-Only)**
- WebSocket для real-time совместной работы
- Nginx reverse proxy для маршрутизации
- Автоматические скрипты запуска

🚀 **Проект готов к использованию с полным функционалом таблиц, включая форматирование, историю изменений, управление участниками и динамическое изменение структуры!**

## API Endpoints - **РАСШИРЕННЫЕ**

### Ячейки
- `PUT /api/cells/sheets/:sheetId/cells/:row/:column` - обновление ячейки
- `GET /api/cells/sheets/:sheetId/cells/:row/:column` - получение ячейки
- **`GET /api/cells/sheets/:sheetId/cells/:row/:column/history` - получение истории изменений ячейки** [НОВОЕ]
- **`POST /api/cells/sheets/:sheetId/format` - применение форматирования к диапазону ячеек** [НОВОЕ]

### Таблицы - **РАСШИРЕННЫЕ**
- `GET /api/sheets` - получение списка таблиц
- `POST /api/sheets` - создание таблицы
- `GET /api/sheets/:id` - получение таблицы
- `PUT /api/sheets/:id` - обновление таблицы
- `DELETE /api/sheets/:id` - удаление таблицы
- **`POST /api/sheets/:id/columns` - добавление столбца** [НОВОЕ]
- **`POST /api/sheets/:id/rows` - добавление строки** [НОВОЕ]
- **`GET /api/sheets/:id/members` - получение участников таблицы** [НОВОЕ]
- **`POST /api/sheets/:id/invite` - приглашение участника** [НОВОЕ]
- **`PATCH /api/sheets/:id/columns/resize` - изменение размера столбца** [НОВОЕ]
- **`PATCH /api/sheets/:id/rows/resize` - изменение размера строки** [НОВОЕ]

## Последние исправления
- ✅ **Исправлена система ролей**: В базе данных роль администратора правильно называется 'admin'
- ✅ **Добавлены разрешения**: Создано 23 базовых разрешения для всех операций системы
- ✅ **Связаны права с ролью**: Администратор получил все необходимые разрешения
- ✅ **Исправлены проверки ролей**: Все маршруты API теперь корректно проверяют роль 'admin' вместо 'Администратор'
- ✅ **Добавлены алиасы маршрутов**: Поддержка /members и /users для групп
- ✅ **Исправлены проблемы API клиента**: 
  - Устранены дублирующиеся `/api/` префиксы в cellsApi и sheetsExtendedApi
  - Исправлена конфигурация NODE_ENV для development тестирования
  - Применена принудительная пересборка frontend без кэша
  - Backend API корректно работает на порту 3001
- ✅ **Исправлена история изменений ячеек**:
  - Создана таблица cell_history в базе данных
  - Добавлены ассоциации CellHistory в models/index.ts
  - Исправлены названия ролей на английские (admin, editor, user)
  - Применена миграция с перезапуском backend
  - ✅ **ПОЛНОСТЬЮ ПРОТЕСТИРОВАНО через Playwright**:
    - Успешная авторизация через https://nginx.raznaradki-from-gs.orb.local/login
    - Корректная работа диалога CellHistoryDialog 
    - Исправлена ошибка Sequelize ассоциаций (алиас 'changedByUser' в контроллере)
    - Пересборка backend с обновленным TypeScript кодом
    - ✅ **API истории изменений работает идеально**:
      - Endpoint /api/cells/sheets/{id}/cells/{row}/{column}/history возвращает 200 OK
      - Полная история с 11 записями изменений
      - Корректные данные пользователей (changedByUser) 
      - Все типы изменений (create, format, formula, value)
- ✅ **ФИНАЛЬНЫЕ ИСПРАВЛЕНИЯ 18.06.2025**:
  - ✅ **Редактирование ячеек по одному клику**: Изменена логика в handleCellClick - первый клик выбирает ячейку, второй клик на выбранную ячейку начинает редактирование
  - ✅ **Правильное отображение изменений значений в истории**: Исправлена логика определения типа изменений в cellController.ts - теперь корректно различаются изменения значений, формул и форматирования
  - ✅ **Автосохранение значений ячеек**: Добавлены обработчики onBlur для автосохранения при потере фокуса и Tab для перехода к следующей ячейке с сохранением значения
  - ✅ **Исправление дубликатов в истории**: Добавлена проверка изменения значений в setCellValue - записи в историю добавляются только при реальных изменениях
  - ✅ **Поддержка Excel-формул**: Реализован полнофункциональный движок FormulaEngine (frontend/src/utils/formulaEngine.ts) с поддержкой:
    - Ссылки на ячейки (A1, B2)
    - Диапазоны ячеек (A1:B5)  
    - Математические операторы (+, -, *, /)
    - Функции: SUM, AVERAGE, MIN, MAX, COUNT, IF, ROUND, ABS, SQRT, POWER
    - Безопасное вычисление с обработкой ошибок
  - ✅ **Все функции полностью протестированы через Playwright**: 
    - Редактирование по одному клику работает корректно
    - Автосохранение при клике на другую ячейку функционирует правильно
    - Tab переходит к следующей ячейке с автосохранением текущей
    - История показывает все типы изменений без дубликатов: значения ("Было: X" → "Стало: Y"), формулы, форматирование, создание
    - Excel-формулы работают: =A1+A2, =SUM(A1:A3) корректно вычисляются и отображаются
    - Формулы отображаются в режиме редактирования, результаты в режиме просмотра

## Безопасность и обновления

### Исправленные уязвимости (последнее обновление)
- ✅ **Обновлен TypeScript**: с версии 3.2.1 до 5.8.3 для улучшения типизации и безопасности
- ✅ **Исправлены уязвимости зависимостей**: применены overrides для принудительного обновления уязвимых пакетов
  - nth-check обновлен до ^2.1.1 (исправлена высокая уязвимость)
  - postcss обновлен до ^8.4.31 (исправлена средняя уязвимость)
  - webpack-dev-server обновлен до ^5.2.1 (исправлена средняя уязвимость)
- ✅ **Обновлен Material-UI Grid API**: переход на новый API Grid v2 с size props
- ✅ **NPM Audit Clean**: 0 уязвимостей

### Исправленные проблемы продакшена (WebSocket/API)
- ✅ **WebSocket подключения**: исправлена конфигурация для HTTPS окружений
- ✅ **Mixed Content блокировка**: API и WebSocket теперь используют относительные URL в продакшене
- ✅ **CORS ошибки**: добавлена поддержка orb.local доменов в backend
- ✅ **HTTPS поддержка**: обновлена nginx конфигурация для SSL терминации
- ✅ **Безопасность заголовков**: добавлены security headers и HSTS

### Используемые версии зависимостей
- React: 19.1.0
- TypeScript: 5.8.3
- Material-UI: 7.1.1
- Redux Toolkit: 2.8.1

## Запуск проекта

### Быстрый запуск через Docker Compose

1. **Автоматический запуск**:
   ```bash
   ./start.sh
   ```

2. **Ручной запуск**:
   ```bash
   # Создать .env файл (если нет)
   cp env.example .env
   
   # Настроить данные администратора в .env (опционально)
   # ADMIN_EMAIL=admin@dmdcottage.com
   # ADMIN_PASSWORD=admin123456
   # ADMIN_FIRST_NAME=Администратор
   # ADMIN_LAST_NAME=Системы
   
   # Запустить все сервисы
   docker-compose up -d
   
   # Проверить статус
   docker-compose ps
   ```

3. **Адреса сервисов**:
   - 🌐 **Приложение**: http://localhost
   - 🔧 **Backend API**: http://localhost:3001  
   - ⚛️ **Frontend**: http://localhost:3000
   - 🗄️ **Adminer (БД)**: http://localhost:8080

### Локальная разработка

**Примечание**: Docker файлы настроены только для production. Для разработки используйте:

```bash
# Backend (разработка)
cd backend 
npm install
npm run dev

# Frontend (разработка в другом терминале)  
cd frontend
npm install
npm start
```

## Дополнительные возможности для развития

- **Расширенная система формул** (как в Excel) - можно добавить больше функций
- **Импорт/экспорт файлов** (XLSX, CSV) - интеграция с библиотеками парсинга
- **Комментарии к ячейкам** - система комментирования для совместной работы
- **Версионирование таблиц** - создание снапшотов состояния таблицы
- **Уведомления пользователей** - push/email уведомления об изменениях
- **Мобильное приложение** - React Native приложение
- **Интеграция с внешними сервисами** - API для подключения других систем
- **Условное форматирование** - автоматическое форматирование на основе значений
- **Фильтры и сортировка** - инструменты для работы с данными
- **Графики и диаграммы** - визуализация данных из таблиц

## Исправленные проблемы
- **Backend TypeScript ошибки**: Исправлена типизация `jwt.sign()` и добавлено обязательное поле `isActive: true` при создании пользователей
- **Frontend совместимость**: Понижена версия TypeScript с ^5.3.3 до ^4.9.5 для совместимости с react-scripts 5.0.1
- **Автоматическое создание администратора**: Добавлена система автоматической инициализации администратора из переменных окружения при первом запуске сервера
- **CORS настройки**: Исправлены настройки CORS в backend для поддержки множественных origins (localhost, localhost:3000)
- **Docker Nginx конфигурация**: Создана правильная конфигурация nginx для проксирования запросов к API и frontend
- **React proxy конфликт**: Удалена конфликтующая настройка proxy из package.json frontend
- **Express trust proxy**: Настроено доверие к nginx прокси для корректной работы express-rate-limit с заголовками X-Forwarded-For
- **Sequelize ассоциации**: Исправлены прямые ассоциации между UserSheet/RolePermission и связанными моделями для корректного include в запросах
- **Все проблемы с функциональностью таблиц устранены**: форматирование, история, участники, добавление строк/столбцов, изменение размеров - все работает

## Новые функции
- **Инициализация администратора**: При запуске сервера автоматически создается пользователь-администратор на основе данных из файла `.env` и переменных окружения Docker Compose
- **Переменные окружения для админа**: 
  - `ADMIN_EMAIL` - email администратора (по умолчанию: admin@dmdcottage.com)
  - `ADMIN_PASSWORD` - пароль администратора (по умолчанию: admin123456)
  - `ADMIN_FIRST_NAME` - имя администратора (по умолчанию: Администратор)
  - `ADMIN_LAST_NAME` - фамилия администратора (по умолчанию: Системы)
- **Docker Compose поддержка**: Переменные администратора автоматически передаются в контейнер backend через docker-compose.yml
- **Полная функциональность таблиц**: все заявленные функции реализованы и работают