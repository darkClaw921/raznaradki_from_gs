# Настройка Webhook для автоматического добавления данных бронирования

## Обзор функциональности

Система webhook позволяет автоматически добавлять данные бронирования в таблицы "Журнал заселения DMD Cottage" при получении уведомлений из внешней системы бронирования.

## Пошаговая настройка

### 1. Настройка в админской панели

1. Войдите в систему как администратор
2. Перейдите в "Панель Администратора"
3. Выберите вкладку "Webhook"
4. Включите webhook переключателем
5. Нажмите "Сгенерировать URL" для создания webhook endpoint
6. Скопируйте сгенерированный URL

### 2. Настройка таблицы журнала

1. Откройте таблицу "Журнал заселения DMD Cottage"
2. Нажмите кнопку "Webhook" в верхней панели
3. Включите webhook для таблицы
4. Добавьте названия апартаментов, которые должны попадать в эту таблицу
   - Например: с045, с046, с047
5. Сохраните настройки

### 3. Настройка в системе бронирования

Используйте сгенерированный URL в настройках webhook вашей системы бронирования.

**Пример URL:** `https://dmd-cottage.alteran-industries.ru/api/webhook/e9518a9e-0c09-4e60-8f77-0f4f2db43636`

## Формат данных webhook

Система ожидает данные в следующем формате:

```json
{
  "data": {
    "booking": {
      "begin_date": "2025-04-14",
      "end_date": "2025-04-17", 
      "apartment": {
        "title": "с045"
      },
      "client": {
        "fio": "Максим Тест",
        "phone": "+7 900 477-74-72"
      },
      "amount": 7800,
      "prepayment": 0,
      "price_per_day": 2600,
      "status_cd": 5,
      "source": "manual",
      "notes": "тестовая бронь - 20  57"
    }
  }
}
```

## Маппинг данных в таблицу

Данные из webhook автоматически добавляются в таблицу в следующем порядке:

| Столбец | Данные | Источник |
|---------|--------|----------|
| 0 | Дата заселения | `booking.begin_date` |
| 1 | Кол-во дней | Рассчитывается из `begin_date` и `end_date` |
| 2 | Дата выселения | `booking.end_date` |
| 3 | ФИО | `booking.client.fio` |
| 4 | Телефон | `booking.client.phone` |
| 5 | Общая сумма проживания | `booking.amount` |
| 6 | Предоплата (сумма аванса) | `booking.prepayment` |
| 7 | Доплата за проживание в день заселения | `booking.price_per_day` |
| 8 | Статус дома | `booking.status_cd` |
| 9 | Источник | `booking.source` |
| 10 | Комментарий по оплате и проживанию | `booking.notes` |

## Тестирование webhook

### Запуск системы

```bash
# Запуск всех сервисов
docker-compose up -d

# Просмотр логов
docker-compose logs -f backend
```

### Тестовый запрос

```bash
# Замените YOUR_WEBHOOK_ID на реальный ID из админской панели
curl -X POST https://dmd-cottage.alteran-industries.ru/api/webhook/YOUR_WEBHOOK_ID \
  -H "Content-Type: application/json" \
  -d @example_request_json_payload.json
```

### Проверка результата

1. Откройте таблицу "Журнал заселения DMD Cottage"
2. Убедитесь, что новая строка с данными бронирования добавлена
3. Проверьте, что данные корректно распределены по столбцам

## Множественные таблицы

Если несколько таблиц настроены на одни и те же апартаменты:
- Данные будут добавлены во все такие таблицы
- Каждая таблица получит отдельную строку с данными

## Безопасность

- Webhook защищен уникальным ID
- Можно включать/отключать через админскую панель
- Валидация всех входящих данных
- Логирование всех операций

## Устранение неполадок

### Webhook не работает

1. Проверьте, что webhook включен в админской панели
2. Убедитесь, что URL корректный
3. Проверьте настройки таблицы (названия апартаментов)
4. Просмотрите логи backend сервиса

### Данные не добавляются

1. Проверьте формат данных webhook
2. Убедитесь, что название апартамента соответствует настроенному
3. Проверьте, что таблица активна для webhook

### Логи для отладки

```bash
# Просмотр логов webhook обработки
docker-compose logs -f backend | grep webhook

# Просмотр всех логов backend
docker-compose logs -f backend
```

## API Endpoints

- `GET /api/system/settings` - получение настроек webhook
- `POST /api/system/webhook/generate` - генерация нового webhook URL
- `PUT /api/system/webhook/toggle` - включение/отключение webhook
- `GET /api/webhook/mapping/:sheetId` - получение настроек маппинга для таблицы
- `PUT /api/webhook/mapping/:sheetId` - обновление настроек маппинга
- `POST /api/webhook/:webhookId` - обработка входящего webhook 